<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Smart Traffic Management System - Enhanced</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
        }

        /* Dashboard Container */
        .dashboard {
            max-width: 1600px;
            margin: 0 auto;
        }

        /* Glassmorphism Card Effect */
        .glass-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .glass-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 40px 0 rgba(31, 38, 135, 0.5);
        }

        /* Header Section */
        .header {
            text-align: center;
            margin-bottom: 30px;
            color: white;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            animation: fadeInDown 0.8s ease;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
            animation: fadeInUp 0.8s ease;
        }

        /* Tab Navigation */
        .tab-container {
            margin-bottom: 20px;
        }

        .tab-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .tab-btn {
            padding: 12px 25px;
            border: none;
            border-radius: 50px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(5px);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .tab-btn.active {
            background: linear-gradient(45deg, #667eea, #764ba2);
            transform: scale(1.05);
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
        }

        .tab-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }

        /* Emergency Banner */
        .emergency-banner {
            background: linear-gradient(45deg, #ff0000, #ff4444);
            color: white;
            padding: 15px 20px;
            border-radius: 50px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            animation: pulse 1s infinite;
            box-shadow: 0 0 30px rgba(255, 0, 0, 0.5);
        }

        .emergency-content {
            display: flex;
            align-items: center;
            gap: 15px;
            font-size: 1.2rem;
            font-weight: bold;
        }

        .emergency-icon {
            font-size: 2rem;
            animation: bounce 1s infinite;
        }

        .emergency-timer {
            background: rgba(255, 255, 255, 0.2);
            padding: 8px 15px;
            border-radius: 25px;
            font-size: 1.1rem;
        }

        /* Control Panel */
        .control-panel {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 30px;
            justify-content: center;
            animation: fadeIn 1s ease;
        }

        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 50px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(5px);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.05);
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
        }

        .btn-primary {
            background: linear-gradient(45deg, #667eea, #764ba2);
            border: none;
        }

        .btn-primary:hover {
            background: linear-gradient(45deg, #764ba2, #667eea);
        }

        .btn-success {
            background: linear-gradient(45deg, #48bb78, #38a169);
        }

        .btn-danger {
            background: linear-gradient(45deg, #f56565, #c53030);
        }

        .btn-info {
            background: linear-gradient(45deg, #4299e1, #3182ce);
        }

        .btn-warning {
            background: linear-gradient(45deg, #ecc94b, #d69e2e);
        }

        .file-input-wrapper {
            position: relative;
            display: inline-block;
        }

        .file-input-wrapper input[type=file] {
            position: absolute;
            width: 0.1px;
            height: 0.1px;
            opacity: 0;
            overflow: hidden;
            z-index: -1;
        }

        .file-label {
            padding: 12px 25px;
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(5px);
            border-radius: 50px;
            color: white;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            transition: all 0.3s ease;
        }

        .file-label:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.05);
        }

        /* Main Content Grid */
        .main-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        /* Video Container */
        .video-container {
            position: relative;
            width: 100%;
            padding-bottom: 56.25%; /* 16:9 Aspect Ratio */
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            overflow: hidden;
            border: 2px solid rgba(255, 255, 255, 0.2);
        }

        .video-container img {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .video-placeholder {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #667eea33, #764ba233);
            color: white;
            font-size: 1.2rem;
            text-align: center;
            backdrop-filter: blur(5px);
            gap: 10px;
        }

        .video-placeholder .small-text {
            font-size: 0.9rem;
            opacity: 0.8;
        }

        /* Traffic Signal Panel */
        .traffic-signal {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
        }

        .signal-lights {
            display: flex;
            gap: 15px;
            justify-content: center;
            background: rgba(0, 0, 0, 0.3);
            padding: 20px;
            border-radius: 50px;
        }

        .light {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            transition: all 0.3s ease;
            position: relative;
        }

        .light.red {
            background: #8b0000;
            box-shadow: 0 0 10px rgba(139, 0, 0, 0.5);
        }

        .light.red.active {
            background: #ff0000;
            box-shadow: 0 0 30px #ff0000, 0 0 60px #ff0000;
            animation: pulse 2s infinite;
        }

        .light.yellow {
            background: #8b8b00;
            box-shadow: 0 0 10px rgba(139, 139, 0, 0.5);
        }

        .light.yellow.active {
            background: #ffff00;
            box-shadow: 0 0 30px #ffff00, 0 0 60px #ffff00;
            animation: pulse 2s infinite;
        }

        .light.green {
            background: #008000;
            box-shadow: 0 0 10px rgba(0, 128, 0, 0.5);
        }

        .light.green.active {
            background: #00ff00;
            box-shadow: 0 0 30px #00ff00, 0 0 60px #00ff00;
            animation: pulse 2s infinite;
        }

        /* Stats Cards Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin: 20px 0;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.15);
            border-radius: 15px;
            padding: 15px;
            text-align: center;
            color: white;
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            background: rgba(255, 255, 255, 0.25);
            transform: scale(1.05);
        }

        .stat-card h3 {
            font-size: 1rem;
            opacity: 0.9;
            margin-bottom: 10px;
        }

        .stat-card .value {
            font-size: 2rem;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        /* Emergency Stat Card */
        .stat-card.emergency {
            background: linear-gradient(45deg, #ff0000, #ff4444);
            animation: pulse 1s infinite;
        }

        /* Vehicle Breakdown */
        .vehicle-breakdown {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-top: 15px;
        }

        .vehicle-item {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 10px;
            text-align: center;
            color: white;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .vehicle-item:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-3px);
        }

        .vehicle-item .count {
            font-size: 1.5rem;
            font-weight: bold;
            display: block;
        }

        /* Signal Timing Panel */
        .timing-panel {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 20px;
        }

        .timing-item {
            text-align: center;
            color: white;
            padding: 10px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
        }

        .timing-item .label {
            font-size: 0.8rem;
            opacity: 0.8;
        }

        .timing-item .value {
            font-size: 1.2rem;
            font-weight: bold;
        }

        /* History Section */
        .history-container {
            margin-top: 30px;
        }

        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .history-controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .history-table-container {
            max-height: 400px;
            overflow-y: auto;
            border-radius: 10px;
            background: rgba(0, 0, 0, 0.2);
        }

        .history-table {
            width: 100%;
            border-collapse: collapse;
            color: white;
        }

        .history-table th {
            position: sticky;
            top: 0;
            background: rgba(0, 0, 0, 0.5);
            padding: 12px;
            text-align: left;
            font-weight: 600;
            backdrop-filter: blur(5px);
        }

        .history-table td {
            padding: 10px 12px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .history-table tr:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .history-table .emergency-row {
            background: rgba(255, 0, 0, 0.2);
        }

        .history-table .emergency-row:hover {
            background: rgba(255, 0, 0, 0.3);
        }

        .density-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: bold;
        }

        .density-badge.low {
            background: #48bb78;
            color: white;
        }

        .density-badge.medium {
            background: #ecc94b;
            color: black;
        }

        .density-badge.high {
            background: #f56565;
            color: white;
        }

        .signal-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: bold;
        }

        .signal-badge.red {
            background: #f56565;
        }

        .signal-badge.yellow {
            background: #ecc94b;
            color: black;
        }

        .signal-badge.green {
            background: #48bb78;
        }

        /* Analytics Grid */
        .analytics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .analytics-card {
            background: rgba(255, 255, 255, 0.15);
            border-radius: 15px;
            padding: 20px;
            color: white;
        }

        .analytics-card h3 {
            margin-bottom: 15px;
            font-size: 1.2rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            padding-bottom: 10px;
        }

        .analytics-stat {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            padding: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
        }

        .analytics-stat .label {
            opacity: 0.8;
        }

        .analytics-stat .value {
            font-weight: bold;
            font-size: 1.1rem;
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(45deg, #667eea, #764ba2);
            border-radius: 10px;
            transition: width 0.3s ease;
        }

        /* Chart Container */
        .chart-container {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            color: white;
        }

        .chart-bar {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }

        .chart-label {
            width: 100px;
        }

        .chart-bar-fill {
            height: 30px;
            background: linear-gradient(45deg, #667eea, #764ba2);
            border-radius: 15px;
            transition: width 0.3s ease;
        }

        .chart-value {
            margin-left: 10px;
            font-weight: bold;
        }

        /* Status Bar */
        .status-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 20px;
            padding: 15px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            color: white;
            flex-wrap: wrap;
            gap: 10px;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #48bb78;
            animation: pulse 2s infinite;
        }

        .status-dot.emergency {
            background: #ff0000;
            animation: pulse 1s infinite;
        }

        .mode-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: bold;
            background: rgba(255, 255, 255, 0.2);
        }

        .mode-badge.image {
            background: #ffaa00;
            color: #000;
        }

        .mode-badge.video {
            background: #48bb78;
        }

        .mode-badge.camera {
            background: #667eea;
        }

        /* Loading Overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }

        /* Notification */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 10px;
            color: white;
            font-weight: 600;
            z-index: 1001;
            animation: slideIn 0.3s ease;
            display: none;
        }

        .notification.success {
            background: linear-gradient(45deg, #48bb78, #38a169);
        }

        .notification.error {
            background: linear-gradient(45deg, #f56565, #c53030);
        }

        .notification.warning {
            background: linear-gradient(45deg, #ffaa00, #ff8800);
        }

        .notification.info {
            background: linear-gradient(45deg, #4299e1, #3182ce);
        }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.8; }
            100% { opacity: 1; }
        }

        @keyframes bounce {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.2); }
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Responsive Design */
        @media (max-width: 1200px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 968px) {
            .header h1 {
                font-size: 2rem;
            }

            .control-panel {
                flex-direction: column;
            }

            .btn, .file-label {
                width: 100%;
                justify-content: center;
            }

            .history-header {
                flex-direction: column;
                align-items: flex-start;
            }

            .history-controls {
                width: 100%;
            }

            .history-controls .btn {
                flex: 1;
            }
        }

        @media (max-width: 480px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }

            .signal-lights {
                flex-direction: column;
                align-items: center;
            }

            .status-bar {
                flex-direction: column;
                text-align: center;
            }

            .emergency-banner {
                flex-direction: column;
                text-align: center;
                gap: 10px;
            }

            .analytics-grid {
                grid-template-columns: 1fr;
            }

            .history-table {
                font-size: 0.8rem;
            }

            .history-table th,
            .history-table td {
                padding: 8px 4px;
            }
        }
    </style>
    <!-- Chart.js for visualizations -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="dashboard">
        <!-- Header -->
        <div class="header">
            <h1>üö¶ AI Smart Traffic Management System</h1>
            <p>Real-time Intelligent Traffic Control with History & Analytics</p>
        </div>

        <!-- Emergency Alert Banner (Hidden by default) -->
        <div id="emergencyBanner" class="emergency-banner" style="display: none;">
            <div class="emergency-content">
                <span class="emergency-icon">üö®</span>
                <span id="emergencyMessage">Emergency Vehicle Detected!</span>
            </div>
            <div class="emergency-timer" id="emergencyTimer">
                Green: 10s
            </div>
        </div>

        <!-- Control Panel -->
        <div class="control-panel">
            <div class="file-input-wrapper">
                <input type="file" id="mediaFile" accept="video/*,image/*">
                <label for="mediaFile" class="file-label">
                    üìÅ Choose Media
                </label>
            </div>
            <button class="btn btn-primary" onclick="uploadMedia()">
                üì§ Upload & Process Media
            </button>
            <button class="btn btn-success" onclick="startCamera()">
                üì∑ Start Live Camera
            </button>
            <button class="btn btn-danger" onclick="stopCamera()">
                ‚èπÔ∏è Stop Camera
            </button>
        </div>

        <!-- Tab Navigation -->
        <div class="tab-container">
            <div class="tab-buttons">
                <button class="tab-btn active" onclick="switchTab('live')">Live Feed</button>
                <button class="tab-btn" onclick="switchTab('history')">History</button>
                <button class="tab-btn" onclick="switchTab('analytics')">Analytics</button>
                <button class="tab-btn" onclick="switchTab('reports')">Reports</button>
            </div>
        </div>

        <!-- Live Feed Tab -->
        <div id="liveTab" class="tab-content active">
            <div class="main-grid">
                <!-- Left Column - Video -->
                <div class="glass-card">
                    <h2 style="color: white; margin-bottom: 15px;">Live Traffic Feed</h2>
                    <div class="video-container">
                        <img id="videoFeed" src="" style="display: none;" alt="Video Feed">
                        <div id="videoPlaceholder" class="video-placeholder">
                            <div>üìπ Upload media or start camera</div>
                            <div class="small-text">Supports: MP4, AVI, MOV, JPG, PNG</div>
                        </div>
                    </div>
                </div>

                <!-- Right Column - Traffic Info -->
                <div class="glass-card">
                    <h2 style="color: white; margin-bottom: 15px;">Traffic Signal Control</h2>
                    
                    <!-- Traffic Signal -->
                    <div class="traffic-signal">
                        <div class="signal-lights">
                            <div class="light red" id="redLight"></div>
                            <div class="light yellow" id="yellowLight"></div>
                            <div class="light green" id="greenLight"></div>
                        </div>
                        <div style="color: white; font-size: 2rem; font-weight: bold;" id="timerDisplay">60s</div>
                    </div>

                    <!-- Stats Cards -->
                    <div class="stats-grid">
                        <div class="stat-card">
                            <h3>Total Vehicles</h3>
                            <div class="value" id="totalVehicles">0</div>
                        </div>
                        <div class="stat-card">
                            <h3>Traffic Density</h3>
                            <div class="value" id="densityLevel">LOW</div>
                        </div>
                        <div class="stat-card">
                            <h3>Signal State</h3>
                            <div class="value" id="signalState">RED</div>
                        </div>
                        <div class="stat-card">
                            <h3>Remaining Timer</h3>
                            <div class="value" id="remainingTimer">60s</div>
                        </div>
                    </div>

                    <!-- Emergency Stats Card (Hidden by default) -->
                    <div id="emergencyStats" class="stat-card emergency" style="display: none; margin-bottom: 15px;">
                        <h3>üö® EMERGENCY VEHICLE</h3>
                        <div class="value" id="emergencyType">AMBULANCE</div>
                        <div style="font-size: 0.9rem; margin-top: 5px;" id="emergencyCountdown">Clearing in: 10s</div>
                    </div>

                    <!-- Vehicle Breakdown -->
                    <h3 style="color: white; margin: 15px 0 10px;">Vehicle Breakdown</h3>
                    <div class="vehicle-breakdown">
                        <div class="vehicle-item">
                            <span>üöó Cars</span>
                            <span class="count" id="carCount">0</span>
                        </div>
                        <div class="vehicle-item">
                            <span>üèç Motorcycles</span>
                            <span class="count" id="motorcycleCount">0</span>
                        </div>
                        <div class="vehicle-item">
                            <span>üöå Buses</span>
                            <span class="count" id="busCount">0</span>
                        </div>
                        <div class="vehicle-item">
                            <span>üöõ Trucks</span>
                            <span class="count" id="truckCount">0</span>
                        </div>
                    </div>

                    <!-- Signal Timing Panel -->
                    <h3 style="color: white; margin: 15px 0 10px;">Signal Timings</h3>
                    <div class="timing-panel">
                        <div class="timing-item">
                            <div class="label">Green</div>
                            <div class="value" id="greenDuration">40s</div>
                        </div>
                        <div class="timing-item">
                            <div class="label">Yellow</div>
                            <div class="value" id="yellowDuration">3s</div>
                        </div>
                        <div class="timing-item">
                            <div class="label">Red</div>
                            <div class="value" id="redDuration">30s</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- History Tab -->
        <div id="historyTab" class="tab-content">
            <div class="glass-card">
                <div class="history-header">
                    <h2 style="color: white;">üìä Traffic History</h2>
                    <div class="history-controls">
                        <button class="btn btn-info" onclick="refreshHistory()">
                            üîÑ Refresh
                        </button>
                        <button class="btn btn-success" onclick="exportHistory()">
                            üì• Export
                        </button>
                        <button class="btn btn-warning" onclick="clearHistory()">
                            üóëÔ∏è Clear
                        </button>
                    </div>
                </div>
                
                <div class="history-table-container">
                    <table class="history-table" id="historyTable">
                        <thead>
                            <tr>
                                <th>Time</th>
                                <th>Total Vehicles</th>
                                <th>Density</th>
                                <th>Signal</th>
                                <th>Cars</th>
                                <th>Motorcycles</th>
                                <th>Buses</th>
                                <th>Trucks</th>
                                <th>Emergency</th>
                            </tr>
                        </thead>
                        <tbody id="historyBody">
                            <tr>
                                <td colspan="9" style="text-align: center; padding: 30px;">
                                    No history data available
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Summary Stats -->
                <div style="margin-top: 20px; display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                    <div class="stat-card">
                        <h3>Total Records</h3>
                        <div class="value" id="totalRecords">0</div>
                    </div>
                    <div class="stat-card">
                        <h3>Avg Vehicles</h3>
                        <div class="value" id="avgVehicles">0</div>
                    </div>
                    <div class="stat-card">
                        <h3>Peak Vehicles</h3>
                        <div class="value" id="peakVehicles">0</div>
                    </div>
                    <div class="stat-card">
                        <h3>Emergency Events</h3>
                        <div class="value" id="emergencyEvents">0</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Analytics Tab -->
        <div id="analyticsTab" class="tab-content">
            <div class="glass-card">
                <h2 style="color: white; margin-bottom: 20px;">üìà Traffic Analytics</h2>
                
                <!-- Charts -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px;">
                    <div class="chart-container">
                        <h3>Vehicle Distribution</h3>
                        <canvas id="vehicleChart"></canvas>
                    </div>
                    <div class="chart-container">
                        <h3>Density Distribution</h3>
                        <canvas id="densityChart"></canvas>
                    </div>
                </div>

                <!-- Analytics Cards -->
                <div class="analytics-grid" id="analyticsGrid">
                    <!-- Will be populated by JavaScript -->
                </div>

                <!-- Time Series Chart -->
                <div class="chart-container" style="margin-top: 20px;">
                    <h3>Traffic Flow Over Time</h3>
                    <canvas id="timeSeriesChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Reports Tab -->
        <div id="reportsTab" class="tab-content">
            <div class="glass-card">
                <h2 style="color: white; margin-bottom: 20px;">üìë Traffic Reports</h2>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 20px;">
                    <div class="analytics-card">
                        <h3>Generate Report</h3>
                        <div style="margin-top: 15px;">
                            <select id="reportType" class="btn" style="width: 100%; margin-bottom: 10px; background: rgba(255,255,255,0.2); color: white;">
                                <option value="summary">Summary Report</option>
                                <option value="detailed">Detailed Report</option>
                                <option value="emergency">Emergency Events Report</option>
                                <option value="peak">Peak Hours Report</option>
                            </select>
                            <button class="btn btn-success" onclick="generateReport()" style="width: 100%;">
                                üìä Generate Report
                            </button>
                        </div>
                    </div>

                    <div class="analytics-card">
                        <h3>Quick Stats</h3>
                        <div class="analytics-stat">
                            <span class="label">Session Duration:</span>
                            <span class="value" id="sessionDuration">0h 0m</span>
                        </div>
                        <div class="analytics-stat">
                            <span class="label">Data Points:</span>
                            <span class="value" id="totalDataPoints">0</span>
                        </div>
                        <div class="analytics-stat">
                            <span class="label">Emergency Events:</span>
                            <span class="value" id="totalEmergencyEvents">0</span>
                        </div>
                    </div>

                    <div class="analytics-card">
                        <h3>Export Options</h3>
                        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                            <button class="btn btn-info" onclick="exportJSON()" style="flex: 1;">JSON</button>
                            <button class="btn btn-success" onclick="exportCSV()" style="flex: 1;">CSV</button>
                            <button class="btn btn-warning" onclick="exportPDF()" style="flex: 1;">PDF</button>
                        </div>
                        <div style="margin-top: 15px;">
                            <button class="btn btn-primary" onclick="emailReport()" style="width: 100%;">
                                üìß Email Report
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Report Preview -->
                <div id="reportPreview" class="glass-card" style="margin-top: 20px; display: none;">
                    <h3 style="color: white; margin-bottom: 15px;">Report Preview</h3>
                    <div id="reportContent" style="color: white; max-height: 400px; overflow-y: auto;"></div>
                </div>
            </div>
        </div>

        <!-- Status Bar -->
        <div class="status-bar">
            <div class="status-item">
                <span class="status-dot" id="statusDot"></span>
                <span id="currentMode">Standby</span>
                <span class="mode-badge" id="modeBadge">STANDBY</span>
            </div>
            <div class="status-item">
                <span>üïê Last Update:</span>
                <span id="lastUpdate">-</span>
            </div>
            <div class="status-item">
                <span>‚öôÔ∏è System Status:</span>
                <span id="systemStatus">Ready</span>
            </div>
            <div class="status-item">
                <span>üíæ Data Points:</span>
                <span id="dataPoints">0</span>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
    </div>

    <!-- Notification -->
    <div class="notification" id="notification"></div>

    <script>
        // API Keys for encryption (matching backend)
        const API_KEYS = [
            "728E339A-93A2-46C8-B82D-7601700F3638",
            "8DC5F86F-F938-4C3A-B9F2-B16D3F964117"
        ];

        // State management
        let statsInterval = null;
        let historyInterval = null;
        let currentFileName = '';
        let historyData = [];
        let charts = {};

        // DOM Elements
        const videoFeed = document.getElementById('videoFeed');
        const videoPlaceholder = document.getElementById('videoPlaceholder');
        const loadingOverlay = document.getElementById('loadingOverlay');
        const notification = document.getElementById('notification');
        const emergencyBanner = document.getElementById('emergencyBanner');
        const emergencyStats = document.getElementById('emergencyStats');
        const statusDot = document.getElementById('statusDot');
        const modeBadge = document.getElementById('modeBadge');

        // File input handler
        document.getElementById('mediaFile').addEventListener('change', function(e) {
            if (e.target.files.length > 0) {
                currentFileName = e.target.files[0].name;
                const fileType = e.target.files[0].type.split('/')[0];
                showNotification(`Selected: ${currentFileName} (${fileType})`, 'success');
            }
        });

        // Tab switching
        function switchTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');

            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(tabName + 'Tab').classList.add('active');

            // Load tab-specific data
            if (tabName === 'history') {
                fetchHistory();
            } else if (tabName === 'analytics') {
                fetchAnalytics();
            }
        }

        // Upload media (video or image)
        async function uploadMedia() {
            const fileInput = document.getElementById('mediaFile');
            if (!fileInput.files.length) {
                showNotification('Please select a media file first', 'error');
                return;
            }

            const formData = new FormData();
            formData.append('video', fileInput.files[0]);

            showLoading(true);
            try {
                const response = await fetch('/upload', {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) throw new Error('Upload failed');

                const data = await response.json();
                
                showNotification('Media processing started', 'success');
                
                // Start video feed
                startVideoFeed();
                updateStatusBar(data.mode, 'Processing');
                updateModeBadge(data.mode, data.mode.toLowerCase());
                
            } catch (error) {
                showNotification('Failed to upload media', 'error');
                console.error(error);
            } finally {
                showLoading(false);
            }
        }

        // Start camera
        async function startCamera() {
            showLoading(true);
            try {
                const response = await fetch('/start_camera');
                if (!response.ok) throw new Error('Failed to start camera');

                const data = await response.json();
                showNotification('Camera started', 'success');
                
                // Start video feed
                startVideoFeed();
                updateStatusBar('Camera', 'Live');
                updateModeBadge('CAMERA', 'camera');
                
            } catch (error) {
                showNotification('Failed to start camera', 'error');
                console.error(error);
            } finally {
                showLoading(false);
            }
        }

        // Stop camera
        async function stopCamera() {
            showLoading(true);
            try {
                const response = await fetch('/stop_camera');
                if (!response.ok) throw new Error('Failed to stop camera');

                const data = await response.json();
                showNotification('Camera stopped', 'success');
                
                // Stop video feed
                stopVideoFeed();
                updateStatusBar('Standby', 'Ready');
                updateModeBadge('STANDBY', 'standby');
                
            } catch (error) {
                showNotification('Failed to stop camera', 'error');
                console.error(error);
            } finally {
                showLoading(false);
            }
        }

        // Start video feed
        function startVideoFeed() {
            videoFeed.src = '/video_feed';
            videoFeed.style.display = 'block';
            videoPlaceholder.style.display = 'none';
            
            // Start stats updates
            if (statsInterval) clearInterval(statsInterval);
            statsInterval = setInterval(fetchStats, 1000);
            
            // Start history updates (every 5 minutes)
            if (historyInterval) clearInterval(historyInterval);
            historyInterval = setInterval(fetchHistory, 300000); // 5 minutes
        }

        // Stop video feed
        function stopVideoFeed() {
            videoFeed.src = '';
            videoFeed.style.display = 'none';
            videoPlaceholder.style.display = 'flex';
            
            // Stop stats updates
            if (statsInterval) {
                clearInterval(statsInterval);
                statsInterval = null;
            }
            
            if (historyInterval) {
                clearInterval(historyInterval);
                historyInterval = null;
            }
            
            // Reset display
            resetDisplay();
            hideEmergencyAlert();
        }

        // Fetch statistics
        async function fetchStats() {
            try {
                const response = await fetch('/stats');
                if (!response.ok) throw new Error('Failed to fetch stats');

                const data = await response.json();
                updateDisplay(data);
                
                // Handle emergency detection
                if (data.emergency && data.emergency.detected) {
                    showEmergencyAlert(data.emergency.type, data.emergency.timeout_remaining);
                } else {
                    hideEmergencyAlert();
                }
                
            } catch (error) {
                console.error('Stats fetch error:', error);
            }
        }

        // Fetch history
        async function fetchHistory() {
            try {
                const response = await fetch('/history');
                if (!response.ok) throw new Error('Failed to fetch history');

                const data = await response.json();
                if (data.history) {
                    // Decrypt history data
                    historyData = decryptData(data.history) || [];
                    displayHistory(historyData);
                    updateHistoryStats(historyData);
                }
                
            } catch (error) {
                console.error('History fetch error:', error);
            }
        }

        // Fetch analytics
        async function fetchAnalytics() {
            try {
                const response = await fetch('/analytics');
                if (!response.ok) throw new Error('Failed to fetch analytics');

                const data = await response.json();
                displayAnalytics(data.analytics);
                updateCharts(data.analytics);
                
            } catch (error) {
                console.error('Analytics fetch error:', error);
            }
        }

        // Simple decryption (matching backend)
        function decryptData(encryptedData) {
            // This is a simplified version - in production, use proper decryption
            try {
                // For demo purposes, we'll just return the data
                // In production, you'd decrypt using the API keys
                return encryptedData;
            } catch (error) {
                console.error('Decryption failed:', error);
                return null;
            }
        }

        // Display history in table
        function displayHistory(data) {
            const tbody = document.getElementById('historyBody');
            
            if (!data || data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" style="text-align: center; padding: 30px;">No history data available</td></tr>';
                return;
            }

            let html = '';
            data.slice().reverse().forEach(item => {
                const emergencyClass = item.emergency_detected ? 'emergency-row' : '';
                html += `
                    <tr class="${emergencyClass}">
                        <td>${new Date(item.timestamp).toLocaleTimeString()}</td>
                        <td>${item.total_vehicles}</td>
                        <td><span class="density-badge ${item.density_level.toLowerCase()}">${item.density_level}</span></td>
                        <td><span class="signal-badge ${item.signal_state.toLowerCase()}">${item.signal_state}</span></td>
                        <td>${item.vehicle_counts?.car || 0}</td>
                        <td>${item.vehicle_counts?.motorcycle || 0}</td>
                        <td>${item.vehicle_counts?.bus || 0}</td>
                        <td>${item.vehicle_counts?.truck || 0}</td>
                        <td>${item.emergency_detected ? 'üö® ' + (item.emergency_type || 'Yes') : '-'}</td>
                    </tr>
                `;
            });

            tbody.innerHTML = html;
        }

        // Update history statistics
        function updateHistoryStats(data) {
            if (!data || data.length === 0) return;

            const totalRecords = data.length;
            const avgVehicles = Math.round(data.reduce((sum, item) => sum + item.total_vehicles, 0) / totalRecords);
            const peakVehicles = Math.max(...data.map(item => item.total_vehicles));
            const emergencyEvents = data.filter(item => item.emergency_detected).length;

            document.getElementById('totalRecords').textContent = totalRecords;
            document.getElementById('avgVehicles').textContent = avgVehicles;
            document.getElementById('peakVehicles').textContent = peakVehicles;
            document.getElementById('emergencyEvents').textContent = emergencyEvents;
            document.getElementById('dataPoints').textContent = totalRecords;
        }

        // Display analytics
        function displayAnalytics(analytics) {
            if (!analytics) return;

            const grid = document.getElementById('analyticsGrid');
            
            // Vehicle distribution
            let vehicleHtml = '<div class="analytics-card"><h3>Vehicle Distribution</h3>';
            if (analytics.vehicle_distribution) {
                const total = Object.values(analytics.vehicle_distribution).reduce((a, b) => a + b, 0);
                for (const [type, count] of Object.entries(analytics.vehicle_distribution)) {
                    const percentage = total > 0 ? Math.round((count / total) * 100) : 0;
                    vehicleHtml += `
                        <div class="analytics-stat">
                            <span class="label">${type}:</span>
                            <span class="value">${count} (${percentage}%)</span>
                        </div>
                    `;
                }
            }
            vehicleHtml += '</div>';

            // Density distribution
            let densityHtml = '<div class="analytics-card"><h3>Density Distribution</h3>';
            if (analytics.density_distribution) {
                const total = Object.values(analytics.density_distribution).reduce((a, b) => a + b, 0);
                for (const [density, count] of Object.entries(analytics.density_distribution)) {
                    const percentage = total > 0 ? Math.round((count / total) * 100) : 0;
                    densityHtml += `
                        <div class="analytics-stat">
                            <span class="label">${density}:</span>
                            <span class="value">${count} (${percentage}%)</span>
                        </div>
                    `;
                }
            }
            densityHtml += '</div>';

            // Summary statistics
            const summaryHtml = `
                <div class="analytics-card">
                    <h3>Summary Statistics</h3>
                    <div class="analytics-stat">
                        <span class="label">Average Vehicles:</span>
                        <span class="value">${analytics.average_vehicles?.toFixed(1) || 0}</span>
                    </div>
                    <div class="analytics-stat">
                        <span class="label">Max Vehicles:</span>
                        <span class="value">${analytics.max_vehicles || 0}</span>
                    </div>
                    <div class="analytics-stat">
                        <span class="label">Min Vehicles:</span>
                        <span class="value">${analytics.min_vehicles || 0}</span>
                    </div>
                    <div class="analytics-stat">
                        <span class="label">Total Data Points:</span>
                        <span class="value">${analytics.total_data_points || 0}</span>
                    </div>
                </div>
            `;

            grid.innerHTML = vehicleHtml + densityHtml + summaryHtml;

            // Update session stats
            if (analytics.start_time && analytics.end_time) {
                const start = new Date(analytics.start_time);
                const end = new Date(analytics.end_time);
                const durationMs = end - start;
                const hours = Math.floor(durationMs / 3600000);
                const minutes = Math.floor((durationMs % 3600000) / 60000);
                document.getElementById('sessionDuration').textContent = `${hours}h ${minutes}m`;
            }

            document.getElementById('totalDataPoints').textContent = analytics.total_data_points || 0;
            document.getElementById('totalEmergencyEvents').textContent = 
                Object.values(analytics.density_distribution || {}).reduce((a, b) => a + b, 0);
        }

        // Update charts
        function updateCharts(analytics) {
            if (!analytics) return;

            // Destroy existing charts
            Object.values(charts).forEach(chart => {
                if (chart) chart.destroy();
            });

            // Vehicle Distribution Chart
            const vehicleCtx = document.getElementById('vehicleChart').getContext('2d');
            if (analytics.vehicle_distribution) {
                charts.vehicleChart = new Chart(vehicleCtx, {
                    type: 'pie',
                    data: {
                        labels: Object.keys(analytics.vehicle_distribution),
                        datasets: [{
                            data: Object.values(analytics.vehicle_distribution),
                            backgroundColor: ['#48bb78', '#ecc94b', '#f56565', '#4299e1']
                        }]
                    },
                    options: {
                        plugins: {
                            legend: {
                                labels: {
                                    color: 'white'
                                }
                            }
                        }
                    }
                });
            }

            // Density Distribution Chart
            const densityCtx = document.getElementById('densityChart').getContext('2d');
            if (analytics.density_distribution) {
                charts.densityChart = new Chart(densityCtx, {
                    type: 'doughnut',
                    data: {
                        labels: Object.keys(analytics.density_distribution),
                        datasets: [{
                            data: Object.values(analytics.density_distribution),
                            backgroundColor: ['#48bb78', '#ecc94b', '#f56565']
                        }]
                    },
                    options: {
                        plugins: {
                            legend: {
                                labels: {
                                    color: 'white'
                                }
                            }
                        }
                    }
                });
            }

            // Time Series Chart
            const timeCtx = document.getElementById('timeSeriesChart').getContext('2d');
            if (historyData.length > 0) {
                const times = historyData.map(item => new Date(item.timestamp).toLocaleTimeString());
                const vehicles = historyData.map(item => item.total_vehicles);

                charts.timeSeriesChart = new Chart(timeCtx, {
                    type: 'line',
                    data: {
                        labels: times,
                        datasets: [{
                            label: 'Vehicle Count',
                            data: vehicles,
                            borderColor: '#667eea',
                            backgroundColor: 'rgba(102, 126, 234, 0.1)',
                            tension: 0.4
                        }]
                    },
                    options: {
                        scales: {
                            y: {
                                beginAtZero: true,
                                grid: {
                                    color: 'rgba(255, 255, 255, 0.1)'
                                },
                                ticks: {
                                    color: 'white'
                                }
                            },
                            x: {
                                grid: {
                                    display: false
                                },
                                ticks: {
                                    color: 'white',
                                    maxRotation: 45
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                labels: {
                                    color: 'white'
                                }
                            }
                        }
                    }
                });
            }
        }

        // Show emergency alert
        function showEmergencyAlert(type, timeout) {
            emergencyBanner.style.display = 'flex';
            emergencyStats.style.display = 'block';
            statusDot.classList.add('emergency');
            
            document.getElementById('emergencyMessage').textContent = 
                `üö® EMERGENCY: ${type} Detected!`;
            document.getElementById('emergencyTimer').textContent = 
                `Green: ${Math.round(timeout)}s`;
            document.getElementById('emergencyType').textContent = type;
            document.getElementById('emergencyCountdown').textContent = 
                `Clearing in: ${Math.round(timeout)}s`;
            
            // Update signal state to show emergency override
            document.getElementById('signalState').textContent = 'GREEN (EMERGENCY)';
        }

        // Hide emergency alert
        function hideEmergencyAlert() {
            emergencyBanner.style.display = 'none';
            emergencyStats.style.display = 'none';
            statusDot.classList.remove('emergency');
        }

        // Update mode badge
        function updateModeBadge(mode, type) {
            modeBadge.textContent = mode;
            modeBadge.className = 'mode-badge';
            if (type) {
                modeBadge.classList.add(type);
            }
        }

        // Update display with new data
        function updateDisplay(data) {
            // Update counts
            document.getElementById('totalVehicles').textContent = data.total_vehicles || 0;
            document.getElementById('densityLevel').textContent = data.density_level || 'LOW';
            
            // Update signal state (show emergency override if active)
            if (data.emergency && data.emergency.detected) {
                document.getElementById('signalState').textContent = 'GREEN (EMERGENCY)';
            } else {
                document.getElementById('signalState').textContent = data.signal_state || 'RED';
            }
            
            document.getElementById('remainingTimer').textContent = data.signal_timer + 's';
            document.getElementById('timerDisplay').textContent = data.signal_timer + 's';

            // Update vehicle breakdown
            const counts = data.vehicle_counts || {};
            document.getElementById('carCount').textContent = counts.car || 0;
            document.getElementById('motorcycleCount').textContent = counts.motorcycle || 0;
            document.getElementById('busCount').textContent = counts.bus || 0;
            document.getElementById('truckCount').textContent = counts.truck || 0;

            // Update traffic lights
            updateTrafficLights(data.signal_state);

            // Update signal timings based on density
            updateSignalTimings(data.density_level);

            // Update last update time
            document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();
            
            // Update system status
            document.getElementById('systemStatus').textContent = 
                data.processing_active ? 'Active' : 'Ready';
            
            // Update current mode
            document.getElementById('currentMode').textContent = data.current_mode || 'Standby';
        }

        // Update traffic lights
        function updateTrafficLights(state) {
            // Remove active class from all lights
            document.getElementById('redLight').classList.remove('active');
            document.getElementById('yellowLight').classList.remove('active');
            document.getElementById('greenLight').classList.remove('active');

            // Add active class to current light
            switch(state) {
                case 'RED':
                    document.getElementById('redLight').classList.add('active');
                    break;
                case 'YELLOW':
                    document.getElementById('yellowLight').classList.add('active');
                    break;
                case 'GREEN':
                    document.getElementById('greenLight').classList.add('active');
                    break;
            }
        }

        // Update signal timings based on density
        function updateSignalTimings(density) {
            let greenTime, yellowTime = 5, redTime;

            switch(density) {
                case 'LOW':
                    greenTime = 10;
                    redTime = 30;
                    break;
                case 'MEDIUM':
                    greenTime = 15;
                    redTime = 15;
                    break;
                case 'HIGH':
                    greenTime = 30;
                    redTime = 10;
                    break;
                default:
                    greenTime = 15;
                    redTime = 15;
            }

            document.getElementById('greenDuration').textContent = greenTime + 's';
            document.getElementById('yellowDuration').textContent = yellowTime + 's';
            document.getElementById('redDuration').textContent = redTime + 's';
        }

        // Update status bar
        function updateStatusBar(mode, status) {
            document.getElementById('currentMode').textContent = mode;
            document.getElementById('systemStatus').textContent = status;
        }

        // Reset display
        function resetDisplay() {
            document.getElementById('totalVehicles').textContent = '0';
            document.getElementById('densityLevel').textContent = 'LOW';
            document.getElementById('signalState').textContent = 'RED';
            document.getElementById('remainingTimer').textContent = '60s';
            document.getElementById('timerDisplay').textContent = '60s';
            document.getElementById('carCount').textContent = '0';
            document.getElementById('motorcycleCount').textContent = '0';
            document.getElementById('busCount').textContent = '0';
            document.getElementById('truckCount').textContent = '0';
            
            updateTrafficLights('RED');
            updateSignalTimings('LOW');
            hideEmergencyAlert();
        }

        // History functions
        async function refreshHistory() {
            showLoading(true);
            await fetchHistory();
            showLoading(false);
            showNotification('History refreshed', 'success');
        }

        function exportHistory() {
            if (!historyData || historyData.length === 0) {
                showNotification('No history data to export', 'warning');
                return;
            }

            const dataStr = JSON.stringify(historyData, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            
            const exportFileDefaultName = `traffic_history_${new Date().toISOString()}.json`;
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
            
            showNotification('History exported successfully', 'success');
        }

        function clearHistory() {
            if (confirm('Are you sure you want to clear all history data?')) {
                historyData = [];
                displayHistory([]);
                updateHistoryStats([]);
                showNotification('History cleared', 'success');
            }
        }

        // Report functions
        async function generateReport() {
            const reportType = document.getElementById('reportType').value;
            showLoading(true);

            try {
                let reportContent = '';
                
                switch(reportType) {
                    case 'summary':
                        reportContent = generateSummaryReport();
                        break;
                    case 'detailed':
                        reportContent = generateDetailedReport();
                        break;
                    case 'emergency':
                        reportContent = generateEmergencyReport();
                        break;
                    case 'peak':
                        reportContent = generatePeakHoursReport();
                        break;
                }

                document.getElementById('reportContent').innerHTML = reportContent;
                document.getElementById('reportPreview').style.display = 'block';
                showNotification('Report generated successfully', 'success');
                
            } catch (error) {
                showNotification('Failed to generate report', 'error');
                console.error(error);
            } finally {
                showLoading(false);
            }
        }

        function generateSummaryReport() {
            if (!historyData || historyData.length === 0) {
                return '<p>No data available for report</p>';
            }

            const totalVehicles = historyData.reduce((sum, item) => sum + item.total_vehicles, 0);
            const avgVehicles = Math.round(totalVehicles / historyData.length);
            const maxVehicles = Math.max(...historyData.map(item => item.total_vehicles));
            const emergencyEvents = historyData.filter(item => item.emergency_detected).length;

            const vehicleTypes = {};
            historyData.forEach(item => {
                for (const [type, count] of Object.entries(item.vehicle_counts || {})) {
                    vehicleTypes[type] = (vehicleTypes[type] || 0) + count;
                }
            });

            let html = `
                <h4>Summary Report - ${new Date().toLocaleDateString()}</h4>
                <div class="analytics-stat"><span class="label">Total Data Points:</span> <span class="value">${historyData.length}</span></div>
                <div class="analytics-stat"><span class="label">Average Vehicles:</span> <span class="value">${avgVehicles}</span></div>
                <div class="analytics-stat"><span class="label">Peak Vehicles:</span> <span class="value">${maxVehicles}</span></div>
                <div class="analytics-stat"><span class="label">Emergency Events:</span> <span class="value">${emergencyEvents}</span></div>
                <h5 style="margin-top: 15px;">Vehicle Type Distribution</h5>
            `;

            for (const [type, count] of Object.entries(vehicleTypes)) {
                html += `<div class="analytics-stat"><span class="label">${type}:</span> <span class="value">${count}</span></div>`;
            }

            return html;
        }

        function generateDetailedReport() {
            if (!historyData || historyData.length === 0) {
                return '<p>No data available for report</p>';
            }

            let html = `
                <h4>Detailed Report - ${new Date().toLocaleDateString()}</h4>
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr>
                            <th style="text-align: left; padding: 8px; border-bottom: 1px solid rgba(255,255,255,0.2);">Time</th>
                            <th style="text-align: left; padding: 8px; border-bottom: 1px solid rgba(255,255,255,0.2);">Vehicles</th>
                            <th style="text-align: left; padding: 8px; border-bottom: 1px solid rgba(255,255,255,0.2);">Density</th>
                            <th style="text-align: left; padding: 8px; border-bottom: 1px solid rgba(255,255,255,0.2);">Signal</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            historyData.slice().reverse().forEach(item => {
                html += `
                    <tr>
                        <td style="padding: 8px; border-bottom: 1px solid rgba(255,255,255,0.1);">${new Date(item.timestamp).toLocaleString()}</td>
                        <td style="padding: 8px; border-bottom: 1px solid rgba(255,255,255,0.1);">${item.total_vehicles}</td>
                        <td style="padding: 8px; border-bottom: 1px solid rgba(255,255,255,0.1);">${item.density_level}</td>
                        <td style="padding: 8px; border-bottom: 1px solid rgba(255,255,255,0.1);">${item.signal_state}</td>
                    </tr>
                `;
            });

            html += '</tbody></table>';
            return html;
        }

        function generateEmergencyReport() {
            const emergencyEvents = historyData.filter(item => item.emergency_detected);
            
            if (emergencyEvents.length === 0) {
                return '<p>No emergency events recorded</p>';
            }

            let html = `
                <h4>Emergency Events Report</h4>
                <div class="analytics-stat"><span class="label">Total Events:</span> <span class="value">${emergencyEvents.length}</span></div>
                <table style="width: 100%; margin-top: 15px;">
                    <thead>
                        <tr>
                            <th style="text-align: left; padding: 8px;">Time</th>
                            <th style="text-align: left; padding: 8px;">Type</th>
                            <th style="text-align: left; padding: 8px;">Vehicles</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            emergencyEvents.forEach(item => {
                html += `
                    <tr>
                        <td style="padding: 8px;">${new Date(item.timestamp).toLocaleString()}</td>
                        <td style="padding: 8px;">${item.emergency_type || 'Unknown'}</td>
                        <td style="padding: 8px;">${item.total_vehicles}</td>
                    </tr>
                `;
            });

            html += '</tbody></table>';
            return html;
        }

        function generatePeakHoursReport() {
            if (!historyData || historyData.length === 0) {
                return '<p>No data available for report</p>';
            }

            // Group by hour
            const hourlyData = {};
            historyData.forEach(item => {
                const hour = new Date(item.timestamp).getHours();
                if (!hourlyData[hour]) {
                    hourlyData[hour] = {
                        total: 0,
                        count: 0,
                        max: 0
                    };
                }
                hourlyData[hour].total += item.total_vehicles;
                hourlyData[hour].count += 1;
                hourlyData[hour].max = Math.max(hourlyData[hour].max, item.total_vehicles);
            });

            // Calculate averages
            for (const [hour, data] of Object.entries(hourlyData)) {
                data.avg = Math.round(data.total / data.count);
            }

            // Sort by average
            const sortedHours = Object.entries(hourlyData)
                .sort((a, b) => b[1].avg - a[1].avg);

            let html = `
                <h4>Peak Hours Report</h4>
                <div class="analytics-stat"><span class="label">Peak Hour:</span> <span class="value">${sortedHours[0][0]}:00 (${sortedHours[0][1].avg} avg vehicles)</span></div>
                <table style="width: 100%; margin-top: 15px;">
                    <thead>
                        <tr>
                            <th style="text-align: left; padding: 8px;">Hour</th>
                            <th style="text-align: left; padding: 8px;">Avg Vehicles</th>
                            <th style="text-align: left; padding: 8px;">Max Vehicles</th>
                            <th style="text-align: left; padding: 8px;">Samples</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            for (const [hour, data] of sortedHours) {
                html += `
                    <tr>
                        <td style="padding: 8px;">${hour}:00</td>
                        <td style="padding: 8px;">${data.avg}</td>
                        <td style="padding: 8px;">${data.max}</td>
                        <td style="padding: 8px;">${data.count}</td>
                    </tr>
                `;
            }

            html += '</tbody></table>';
            return html;
        }

        // Export functions
        function exportJSON() {
            if (!historyData || historyData.length === 0) {
                showNotification('No data to export', 'warning');
                return;
            }

            const dataStr = JSON.stringify(historyData, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            
            const exportFileDefaultName = `traffic_data_${new Date().toISOString()}.json`;
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
            
            showNotification('Data exported as JSON', 'success');
        }

        function exportCSV() {
            if (!historyData || historyData.length === 0) {
                showNotification('No data to export', 'warning');
                return;
            }

            // Create CSV headers
            const headers = ['Timestamp', 'Total Vehicles', 'Density', 'Signal State', 'Cars', 'Motorcycles', 'Buses', 'Trucks', 'Emergency'];
            
            // Create CSV rows
            const rows = historyData.map(item => [
                item.timestamp,
                item.total_vehicles,
                item.density_level,
                item.signal_state,
                item.vehicle_counts?.car || 0,
                item.vehicle_counts?.motorcycle || 0,
                item.vehicle_counts?.bus || 0,
                item.vehicle_counts?.truck || 0,
                item.emergency_detected ? 'Yes' : 'No'
            ]);

            // Combine headers and rows
            const csvContent = [headers.join(','), ...rows.map(row => row.join(','))].join('\n');
            
            const dataUri = 'data:text/csv;charset=utf-8,'+ encodeURIComponent(csvContent);
            
            const exportFileDefaultName = `traffic_data_${new Date().toISOString()}.csv`;
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
            
            showNotification('Data exported as CSV', 'success');
        }

        function exportPDF() {
            showNotification('PDF export coming soon', 'info');
        }

        function emailReport() {
            showNotification('Email feature coming soon', 'info');
        }

        // Show/hide loading overlay
        function showLoading(show) {
            loadingOverlay.style.display = show ? 'flex' : 'none';
        }

        // Show notification
        function showNotification(message, type) {
            notification.textContent = message;
            notification.className = `notification ${type}`;
            notification.style.display = 'block';

            setTimeout(() => {
                notification.style.display = 'none';
            }, 3000);
        }

        // Initialize
        resetDisplay();
        updateStatusBar('Standby', 'Ready');
        updateModeBadge('STANDBY', 'standby');

        // Cleanup on page unload
        window.addEventListener('beforeunload', function() {
            if (statsInterval) {
                clearInterval(statsInterval);
            }
            if (historyInterval) {
                clearInterval(historyInterval);
            }
        });
    </script>
</body>
</html>
