<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Smart Traffic Management System | Neural Traffic Control</title>
    <!-- Font Awesome 6 (Free) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts - Inter & Space Grotesk -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Space+Grotesk:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- GSAP for animations -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/ScrollTrigger.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #4361ee;
            --primary-light: #4895ef;
            --primary-dark: #3f37c9;
            --secondary: #f72585;
            --success: #4cc9f0;
            --warning: #f8961e;
            --danger: #f94144;
            --dark: #0b090a;
            --dark-light: #161a1d;
            --light: #f8f9fa;
            --gray: #adb5bd;
            --glass-bg: rgba(255, 255, 255, 0.05);
            --glass-border: rgba(255, 255, 255, 0.1);
            --glass-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.36);
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #0a0a0f 0%, #1a1b2f 50%, #0f0f1a 100%);
            color: var(--light);
            min-height: 100vh;
            overflow-x: hidden;
            position: relative;
        }

        /* Animated Background */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 20% 50%, rgba(67, 97, 238, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(247, 37, 133, 0.1) 0%, transparent 50%);
            pointer-events: none;
            z-index: -1;
            animation: pulseGlow 10s ease infinite;
        }

        @keyframes pulseGlow {
            0%, 100% { opacity: 0.5; }
            50% { opacity: 1; }
        }

        /* Floating Particles */
        .particles {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: -1;
        }

        .particle {
            position: absolute;
            width: 2px;
            height: 2px;
            background: rgba(255, 255, 255, 0.5);
            border-radius: 50%;
            animation: float 20s infinite linear;
        }

        @keyframes float {
            from { transform: translateY(100vh) rotate(0deg); opacity: 0; }
            to { transform: translateY(-100px) rotate(360deg); opacity: 1; }
        }

        /* Main Container */
        .dashboard {
            max-width: 1800px;
            margin: 0 auto;
            padding: 20px;
            position: relative;
            z-index: 1;
        }

        /* Header with 3D Effect */
        .header {
            text-align: center;
            margin-bottom: 40px;
            padding: 30px;
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
            border-radius: 30px;
            box-shadow: var(--glass-shadow);
            transform: perspective(1000px) rotateX(2deg);
            animation: headerFloat 6s ease infinite;
        }

        @keyframes headerFloat {
            0%, 100% { transform: perspective(1000px) rotateX(2deg) translateY(0); }
            50% { transform: perspective(1000px) rotateX(2deg) translateY(-10px); }
        }

        .header h1 {
            font-family: 'Space Grotesk', sans-serif;
            font-size: 3.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, #fff, var(--primary-light), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 15px;
            text-shadow: 0 0 30px rgba(67, 97, 238, 0.3);
            animation: titleGlow 3s ease infinite;
        }

        @keyframes titleGlow {
            0%, 100% { filter: drop-shadow(0 0 20px rgba(67, 97, 238, 0.5)); }
            50% { filter: drop-shadow(0 0 40px rgba(247, 37, 133, 0.5)); }
        }

        .header p {
            font-size: 1.2rem;
            color: var(--gray);
            letter-spacing: 1px;
        }

        /* Control Panel with Neon Effect */
        .control-panel {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            justify-content: center;
            margin-bottom: 40px;
            padding: 20px;
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
            border-radius: 50px;
            box-shadow: var(--glass-shadow);
        }

        .btn {
            padding: 14px 28px;
            border: none;
            border-radius: 50px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            background: var(--glass-bg);
            backdrop-filter: blur(5px);
            color: var(--light);
            border: 1px solid var(--glass-border);
            display: inline-flex;
            align-items: center;
            gap: 10px;
            position: relative;
            overflow: hidden;
            z-index: 1;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
            z-index: -1;
        }

        .btn:hover::before {
            left: 100%;
        }

        .btn:hover {
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3), 0 0 20px var(--primary);
            border-color: var(--primary);
        }

        .btn-primary {
            background: linear-gradient(45deg, var(--primary), var(--primary-dark));
            border: none;
        }

        .btn-primary:hover {
            background: linear-gradient(45deg, var(--primary-dark), var(--primary));
            box-shadow: 0 0 30px var(--primary);
        }

        .btn-success {
            background: linear-gradient(45deg, var(--success), #3a86ff);
        }

        .btn-danger {
            background: linear-gradient(45deg, var(--danger), #dc2f2f);
        }

        .btn-warning {
            background: linear-gradient(45deg, var(--warning), #f48c06);
        }

        .btn-info {
            background: linear-gradient(45deg, var(--primary-light), var(--success));
        }

        /* File Input Styling */
        .file-input-wrapper {
            position: relative;
        }

        .file-input-wrapper input[type=file] {
            position: absolute;
            width: 0.1px;
            height: 0.1px;
            opacity: 0;
            overflow: hidden;
            z-index: -1;
        }

        .file-label {
            padding: 14px 28px;
            background: var(--glass-bg);
            backdrop-filter: blur(5px);
            border-radius: 50px;
            color: var(--light);
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            border: 1px solid var(--glass-border);
            transition: all 0.3s ease;
        }

        .file-label:hover {
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3), 0 0 20px var(--primary-light);
            border-color: var(--primary-light);
        }

        /* Tab Navigation - Glass Morphism */
        .tab-container {
            margin-bottom: 30px;
        }

        .tab-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
            padding: 15px;
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
            border-radius: 50px;
            box-shadow: var(--glass-shadow);
        }

        .tab-btn {
            padding: 12px 24px;
            border: none;
            border-radius: 40px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            background: transparent;
            color: var(--gray);
            position: relative;
            overflow: hidden;
        }

        .tab-btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(67, 97, 238, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
            z-index: -1;
        }

        .tab-btn:hover::before {
            width: 300px;
            height: 300px;
        }

        .tab-btn.active {
            background: linear-gradient(45deg, var(--primary), var(--secondary));
            color: white;
            box-shadow: 0 0 30px var(--primary);
        }

        .tab-content {
            display: none;
            animation: fadeInUp 0.5s ease;
        }

        .tab-content.active {
            display: block;
        }

        /* Main Grid - Live Feed */
        .main-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 25px;
            margin-bottom: 25px;
        }

        /* Glass Card with Hover Effects */
        .glass-card {
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
            border-radius: 30px;
            padding: 25px;
            box-shadow: var(--glass-shadow);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .glass-card::after {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.1) 0%, transparent 70%);
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
        }

        .glass-card:hover::after {
            opacity: 1;
        }

        .glass-card:hover {
            transform: translateY(-5px) scale(1.02);
            border-color: var(--primary);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.4), 0 0 30px var(--primary);
        }

        /* Video Container with 3D Effect */
        .video-container {
            position: relative;
            width: 100%;
            padding-bottom: 56.25%;
            border-radius: 20px;
            overflow: hidden;
            border: 2px solid var(--glass-border);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.4);
            transform: perspective(1000px) rotateX(2deg);
            transition: transform 0.3s;
        }

        .video-container:hover {
            transform: perspective(1000px) rotateX(0deg) scale(1.02);
        }

        .video-container img {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .video-placeholder {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, rgba(67, 97, 238, 0.2), rgba(247, 37, 133, 0.2));
            color: white;
            font-size: 1.2rem;
            backdrop-filter: blur(5px);
        }

        /* Traffic Signal with Neon Lights */
        .traffic-signal {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            margin: 25px 0;
        }

        .signal-lights {
            display: flex;
            gap: 25px;
            padding: 30px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 60px;
            border: 1px solid var(--glass-border);
            box-shadow: inset 0 0 30px rgba(0, 0, 0, 0.5);
        }

        .light {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            transition: all 0.3s ease;
            position: relative;
            filter: drop-shadow(0 0 10px rgba(0, 0, 0, 0.5));
        }

        .light::after {
            content: '';
            position: absolute;
            top: -10px;
            left: -10px;
            right: -10px;
            bottom: -10px;
            border-radius: 50%;
            background: inherit;
            filter: blur(15px);
            opacity: 0;
            transition: opacity 0.3s;
            z-index: -1;
        }

        .light.active::after {
            opacity: 0.7;
        }

        .light.red {
            background: #8b0000;
            box-shadow: 0 0 20px #8b0000;
        }

        .light.red.active {
            background: #ff0000;
            animation: pulseRed 1.5s ease infinite;
        }

        @keyframes pulseRed {
            0%, 100% { box-shadow: 0 0 30px #ff0000, 0 0 60px #ff0000; }
            50% { box-shadow: 0 0 50px #ff0000, 0 0 100px #ff0000; }
        }

        .light.yellow {
            background: #8b8b00;
            box-shadow: 0 0 20px #8b8b00;
        }

        .light.yellow.active {
            background: #ffff00;
            animation: pulseYellow 1.5s ease infinite;
        }

        @keyframes pulseYellow {
            0%, 100% { box-shadow: 0 0 30px #ffff00, 0 0 60px #ffff00; }
            50% { box-shadow: 0 0 50px #ffff00, 0 0 100px #ffff00; }
        }

        .light.green {
            background: #008000;
            box-shadow: 0 0 20px #008000;
        }

        .light.green.active {
            background: #00ff00;
            animation: pulseGreen 1.5s ease infinite;
        }

        @keyframes pulseGreen {
            0%, 100% { box-shadow: 0 0 30px #00ff00, 0 0 60px #00ff00; }
            50% { box-shadow: 0 0 50px #00ff00, 0 0 100px #00ff00; }
        }

        /* Timer Display */
        #timerDisplay {
            font-size: 3.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, #fff, var(--primary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 0 30px var(--primary);
            animation: timerPulse 2s ease infinite;
        }

        @keyframes timerPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        /* Stats Cards with 3D Flip */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin: 25px 0;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 20px;
            text-align: center;
            transition: all 0.3s;
            cursor: pointer;
            transform-style: preserve-3d;
            perspective: 1000px;
        }

        .stat-card:hover {
            transform: rotateY(10deg) rotateX(5deg) translateY(-5px);
            background: rgba(255, 255, 255, 0.15);
            box-shadow: 0 20px 30px rgba(0, 0, 0, 0.3);
        }

        .stat-card h3 {
            font-size: 1rem;
            color: var(--gray);
            margin-bottom: 10px;
        }

        .stat-card .value {
            font-size: 2.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, #fff, var(--primary-light));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        /* Vehicle Breakdown */
        .vehicle-breakdown {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-top: 20px;
        }

        .vehicle-item {
            background: rgba(255, 255, 255, 0.08);
            border-radius: 15px;
            padding: 15px;
            text-align: center;
            transition: all 0.3s;
            border: 1px solid var(--glass-border);
        }

        .vehicle-item:hover {
            transform: translateY(-5px) scale(1.05);
            background: rgba(255, 255, 255, 0.15);
            border-color: var(--primary);
        }

        .vehicle-item span:first-child {
            display: block;
            font-size: 1.2rem;
            margin-bottom: 8px;
        }

        .vehicle-item .count {
            font-size: 2rem;
            font-weight: 700;
            background: linear-gradient(135deg, #fff, var(--success));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        /* Timing Panel */
        .timing-panel {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-top: 20px;
        }

        .timing-item {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            padding: 15px;
            text-align: center;
            border: 1px solid var(--glass-border);
            transition: all 0.3s;
        }

        .timing-item:hover {
            transform: translateY(-3px);
            border-color: var(--primary);
            box-shadow: 0 0 20px var(--primary);
        }

        .timing-item .label {
            color: var(--gray);
            font-size: 0.9rem;
            margin-bottom: 8px;
        }

        .timing-item .value {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--primary-light);
        }

        /* History Table with Glow */
        .history-table-container {
            max-height: 500px;
            overflow-y: auto;
            border-radius: 20px;
            background: rgba(0, 0, 0, 0.2);
            scrollbar-width: thin;
            scrollbar-color: var(--primary) var(--dark);
        }

        .history-table-container::-webkit-scrollbar {
            width: 8px;
        }

        .history-table-container::-webkit-scrollbar-track {
            background: var(--dark);
            border-radius: 10px;
        }

        .history-table-container::-webkit-scrollbar-thumb {
            background: var(--primary);
            border-radius: 10px;
        }

        .history-table {
            width: 100%;
            border-collapse: collapse;
        }

        .history-table th {
            position: sticky;
            top: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
            padding: 15px;
            font-weight: 600;
            color: var(--primary-light);
            border-bottom: 2px solid var(--primary);
        }

        .history-table td {
            padding: 12px 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .history-table tr {
            transition: all 0.2s;
        }

        .history-table tr:hover {
            background: rgba(67, 97, 238, 0.1);
            transform: scale(1.01);
        }

        /* Badges */
        .density-badge, .signal-badge {
            padding: 6px 12px;
            border-radius: 30px;
            font-size: 0.85rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .density-badge.low, .signal-badge.green {
            background: rgba(76, 201, 240, 0.2);
            color: var(--success);
            border: 1px solid var(--success);
        }

        .density-badge.medium, .signal-badge.yellow {
            background: rgba(248, 150, 30, 0.2);
            color: var(--warning);
            border: 1px solid var(--warning);
        }

        .density-badge.high, .signal-badge.red {
            background: rgba(249, 65, 68, 0.2);
            color: var(--danger);
            border: 1px solid var(--danger);
        }

        /* Settings Grid */
        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 25px;
        }

        .settings-section {
            background: rgba(255, 255, 255, 0.08);
            border-radius: 25px;
            padding: 25px;
            border: 1px solid var(--glass-border);
            transition: all 0.3s;
        }

        .settings-section:hover {
            border-color: var(--primary);
            box-shadow: 0 0 30px rgba(67, 97, 238, 0.2);
            transform: translateY(-5px);
        }

        .settings-section h3 {
            font-size: 1.3rem;
            margin-bottom: 20px;
            color: var(--primary-light);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: var(--gray);
            font-size: 0.95rem;
        }

        .form-group input[type="number"],
        .form-group input[type="email"],
        .form-group select {
            width: 100%;
            padding: 12px 15px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            color: var(--light);
            font-size: 1rem;
            transition: all 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 20px var(--primary);
        }

        .form-group.checkbox {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .form-group.checkbox input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
            accent-color: var(--primary);
        }

        /* Signal Durations Grid */
        .signal-durations {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
        }

        .duration-item {
            text-align: center;
        }

        .duration-item label {
            font-size: 0.85rem;
            margin-bottom: 5px;
        }

        .duration-item input {
            text-align: center;
        }

        /* Alert Types Grid */
        .alert-types {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }

        /* Status Bar with Glow */
        .status-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 30px;
            padding: 20px 30px;
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
            border-radius: 60px;
            box-shadow: var(--glass-shadow);
            flex-wrap: wrap;
            gap: 15px;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 16px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 40px;
            transition: all 0.3s;
        }

        .status-item:hover {
            background: rgba(67, 97, 238, 0.2);
            transform: scale(1.05);
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--success);
            animation: pulseDot 2s ease infinite;
        }

        @keyframes pulseDot {
            0%, 100% { box-shadow: 0 0 10px var(--success); }
            50% { box-shadow: 0 0 20px var(--success); }
        }

        .mode-badge {
            padding: 4px 12px;
            border-radius: 30px;
            font-size: 0.8rem;
            font-weight: 600;
            background: linear-gradient(45deg, var(--primary), var(--secondary));
        }

        /* Loading Overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid var(--glass-border);
            border-top-color: var(--primary);
            border-right-color: var(--secondary);
            border-radius: 50%;
            animation: spin 1s cubic-bezier(0.68, -0.55, 0.265, 1.55) infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Notification */
        .notification {
            position: fixed;
            top: 30px;
            right: 30px;
            padding: 18px 30px;
            border-radius: 60px;
            color: white;
            font-weight: 600;
            z-index: 10000;
            animation: slideInRight 0.3s ease, glowPulse 2s ease infinite;
            display: none;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes glowPulse {
            0%, 100% { box-shadow: 0 0 20px currentColor; }
            50% { box-shadow: 0 0 40px currentColor; }
        }

        .notification.success {
            background: linear-gradient(45deg, var(--success), #3a86ff);
        }

        .notification.error {
            background: linear-gradient(45deg, var(--danger), #dc2f2f);
        }

        .notification.warning {
            background: linear-gradient(45deg, var(--warning), #f48c06);
        }

        .notification.info {
            background: linear-gradient(45deg, var(--primary), var(--secondary));
        }

        /* Animations */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Responsive Design */
        @media (max-width: 1200px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 2rem;
            }

            .control-panel {
                flex-direction: column;
            }

            .btn, .file-label {
                width: 100%;
                justify-content: center;
            }

            .tab-buttons {
                flex-direction: column;
            }

            .tab-btn {
                width: 100%;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .signal-lights {
                flex-direction: column;
                align-items: center;
            }

            .status-bar {
                flex-direction: column;
                text-align: center;
            }

            .settings-grid {
                grid-template-columns: 1fr;
            }

            .signal-durations,
            .alert-types {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 480px) {
            .header h1 {
                font-size: 1.5rem;
            }

            .vehicle-breakdown {
                grid-template-columns: 1fr;
            }

            .timing-panel {
                grid-template-columns: 1fr;
            }
        }

        /* Analytics Cards */
        .analytics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 25px;
        }

        .analytics-card {
            background: rgba(255, 255, 255, 0.08);
            border-radius: 20px;
            padding: 20px;
            border: 1px solid var(--glass-border);
            transition: all 0.3s;
        }

        .analytics-card:hover {
            transform: translateY(-5px);
            border-color: var(--primary);
            box-shadow: 0 0 30px rgba(67, 97, 238, 0.2);
        }

        .analytics-stat {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .analytics-stat:last-child {
            border-bottom: none;
        }

        .analytics-stat .label {
            color: var(--gray);
        }

        .analytics-stat .value {
            font-weight: 600;
            color: var(--primary-light);
        }

        /* Progress Bar */
        .progress-bar {
            width: 100%;
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            overflow: hidden;
            margin: 15px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(45deg, var(--primary), var(--secondary));
            border-radius: 10px;
            transition: width 0.5s ease;
        }

        /* Predictions List */
        .predictions-panel {
            margin-top: 25px;
            padding: 20px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 20px;
            border: 1px solid var(--glass-border);
        }

        .prediction-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            transition: all 0.3s;
        }

        .prediction-item:hover {
            background: rgba(67, 97, 238, 0.1);
            transform: translateX(5px);
        }

        .prediction-item:last-child {
            border-bottom: none;
        }

        .prediction-hour {
            font-weight: 600;
            color: var(--primary-light);
        }

        .prediction-density {
            padding: 4px 12px;
            border-radius: 30px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        /* Chart Containers */
        .chart-container {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 20px;
            padding: 20px;
            border: 1px solid var(--glass-border);
            position: relative;
            height: 350px;
        }

        .chart-container canvas {
            max-height: 280px;
            width: 100% !important;
        }

        /* Report Preview */
        .report-preview {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 20px;
            padding: 25px;
            margin-top: 25px;
            max-height: 500px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <!-- Floating Particles Background -->
    <div class="particles" id="particles"></div>

    <div class="dashboard">
        <!-- Header -->
        <div class="header">
            <h1><i class="fas fa-microchip"></i> SMART TRAFFIC CONTROL</h1>
            <p>AI-Powered Intelligent Traffic Management System with Predictive Analytics</p>
        </div>

        <!-- Control Panel -->
        <div class="control-panel">
            <div class="file-input-wrapper">
                <input type="file" id="mediaFile" accept="video/*,image/*">
                <label for="mediaFile" class="file-label">
                    <i class="fas fa-cloud-upload-alt"></i> Choose Media
                </label>
            </div>
            <button class="btn btn-primary" onclick="uploadMedia()">
                <i class="fas fa-play"></i> Upload & Process
            </button>
            <button class="btn btn-success" onclick="startCamera()">
                <i class="fas fa-video"></i> Start Camera
            </button>
            <button class="btn btn-danger" onclick="stopCamera()">
                <i class="fas fa-stop"></i> Stop Camera
            </button>
            <button class="btn btn-info" onclick="forceStore()">
                <i class="fas fa-save"></i> Force Store
            </button>
            <button class="btn btn-warning" onclick="checkDatabase()">
                <i class="fas fa-database"></i> DB Stats
            </button>
            <button class="btn btn-primary" onclick="forceTrain()">
                <i class="fas fa-robot"></i> Train Model
            </button>
        </div>

        <!-- Tab Navigation -->
        <div class="tab-container">
            <div class="tab-buttons">
                <button class="tab-btn active" onclick="switchTab('live')"><i class="fas fa-broadcast-tower"></i> Live Feed</button>
                <button class="tab-btn" onclick="switchTab('history')"><i class="fas fa-history"></i> History</button>
                <button class="tab-btn" onclick="switchTab('analytics')"><i class="fas fa-chart-line"></i> Analytics</button>
                <button class="tab-btn" onclick="switchTab('predictions')"><i class="fas fa-brain"></i> Predictions</button>
                <button class="tab-btn" onclick="switchTab('settings')"><i class="fas fa-cog"></i> Settings</button>
                <button class="tab-btn" onclick="switchTab('reports')"><i class="fas fa-file-alt"></i> Reports</button>
            </div>
        </div>

        <!-- Live Feed Tab -->
        <div id="liveTab" class="tab-content active">
            <div class="main-grid">
                <!-- Left Column - Video -->
                <div class="glass-card">
                    <h2 style="color: white; margin-bottom: 20px;"><i class="fas fa-eye"></i> Live Traffic Feed</h2>
                    <div class="video-container">
                        <img id="videoFeed" src="" style="display: none;" alt="Video Feed">
                        <div id="videoPlaceholder" class="video-placeholder">
                            <i class="fas fa-video" style="font-size: 4rem; margin-bottom: 20px; opacity: 0.5;"></i>
                            <div>Upload media or start camera</div>
                            <div class="small-text" style="font-size: 0.9rem; margin-top: 10px;">Supports: MP4, AVI, MOV, JPG, PNG</div>
                        </div>
                    </div>
                </div>

                <!-- Right Column - Traffic Info -->
                <div class="glass-card">
                    <h2 style="color: white; margin-bottom: 20px;"><i class="fas fa-traffic-light"></i> Traffic Signal Control</h2>
                    
                    <!-- Traffic Signal -->
                    <div class="traffic-signal">
                        <div class="signal-lights">
                            <div class="light red" id="redLight"></div>
                            <div class="light yellow" id="yellowLight"></div>
                            <div class="light green" id="greenLight"></div>
                        </div>
                        <div style="font-size: 3.5rem; font-weight: bold;" id="timerDisplay">0s</div>
                    </div>

                    <!-- Mode Control Buttons -->
                    <div style="display: flex; gap: 15px; margin: 25px 0;">
                        <button class="btn btn-success" onclick="setMode('AUTO')" style="flex: 1;"><i class="fas fa-robot"></i> AUTO Mode</button>
                        <button class="btn btn-warning" onclick="setMode('MANUAL')" style="flex: 1;"><i class="fas fa-hand-paper"></i> MANUAL Mode</button>
                    </div>

                    <!-- Manual Control Buttons -->
                    <div id="manualControls" style="display: none; gap: 15px; margin: 20px 0;">
                        <button class="btn btn-danger" onclick="setSignal('RED')" style="flex: 1;"><i class="fas fa-circle"></i> RED</button>
                        <button class="btn btn-warning" onclick="setSignal('YELLOW')" style="flex: 1;"><i class="fas fa-circle"></i> YELLOW</button>
                        <button class="btn btn-success" onclick="setSignal('GREEN')" style="flex: 1;"><i class="fas fa-circle"></i> GREEN</button>
                    </div>

                    <!-- Stats Cards -->
                    <div class="stats-grid">
                        <div class="stat-card">
                            <h3><i class="fas fa-car"></i> Total Vehicles</h3>
                            <div class="value" id="totalVehicles">0</div>
                        </div>
                        <div class="stat-card">
                            <h3><i class="fas fa-chart-bar"></i> Traffic Density</h3>
                            <div class="value" id="densityLevel">LOW</div>
                        </div>
                        <div class="stat-card">
                            <h3><i class="fas fa-traffic-light"></i> Signal State</h3>
                            <div class="value" id="signalState">RED</div>
                        </div>
                        <div class="stat-card">
                            <h3><i class="fas fa-hourglass-half"></i> Remaining Timer</h3>
                            <div class="value" id="remainingTimer">0s</div>
                        </div>
                    </div>

                    <!-- Vehicle Breakdown -->
                    <h3 style="color: white; margin: 20px 0 15px;"><i class="fas fa-truck"></i> Vehicle Breakdown</h3>
                    <div class="vehicle-breakdown">
                        <div class="vehicle-item">
                            <span><i class="fas fa-car"></i> Cars</span>
                            <span class="count" id="carCount">0</span>
                        </div>
                        <div class="vehicle-item">
                            <span><i class="fas fa-motorcycle"></i> Motorcycles</span>
                            <span class="count" id="motorcycleCount">0</span>
                        </div>
                        <div class="vehicle-item">
                            <span><i class="fas fa-bus"></i> Buses</span>
                            <span class="count" id="busCount">0</span>
                        </div>
                        <div class="vehicle-item">
                            <span><i class="fas fa-truck"></i> Trucks</span>
                            <span class="count" id="truckCount">0</span>
                        </div>
                    </div>

                    <!-- Signal Timing Panel -->
                    <h3 style="color: white; margin: 20px 0 15px;"><i class="fas fa-clock"></i> Signal Timings</h3>
                    <div class="timing-panel">
                        <div class="timing-item">
                            <div class="label">LOW Density</div>
                            <div class="value" id="lowTimings">G:10 Y:5 R:30</div>
                        </div>
                        <div class="timing-item">
                            <div class="label">MEDIUM Density</div>
                            <div class="value" id="mediumTimings">G:15 Y:5 R:15</div>
                        </div>
                        <div class="timing-item">
                            <div class="label">HIGH Density</div>
                            <div class="value" id="highTimings">G:30 Y:5 R:10</div>
                        </div>
                    </div>

                    <!-- Storage Info -->
                    <div style="margin-top: 20px; text-align: center; color: var(--gray);">
                        <i class="fas fa-database"></i> <span id="storageInfo">Records in DB: 0 | Next storage: 5min</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- History Tab -->
        <div id="historyTab" class="tab-content">
            <div class="glass-card">
                <div class="history-header">
                    <h2 style="color: white;"><i class="fas fa-history"></i> Traffic History</h2>
                    <div class="history-controls" style="display: flex; gap: 10px; margin-top: 15px;">
                        <button class="btn btn-info" onclick="refreshHistory()">
                            <i class="fas fa-sync-alt"></i> Refresh
                        </button>
                        <button class="btn btn-success" onclick="exportJSON()">
                            <i class="fas fa-file-code"></i> Export JSON
                        </button>
                        <button class="btn btn-warning" onclick="exportCSV()">
                            <i class="fas fa-file-csv"></i> Export CSV
                        </button>
                        <button class="btn btn-danger" onclick="exportPDF()">
                            <i class="fas fa-file-pdf"></i> Export PDF
                        </button>
                    </div>
                </div>
                
                <div class="history-table-container">
                    <table class="history-table" id="historyTable">
                        <thead>
                            <tr>
                                <th>Time</th>
                                <th>Total</th>
                                <th>Density</th>
                                <th>Signal</th>
                                <th>Cars</th>
                                <th>Mcycles</th>
                                <th>Buses</th>
                                <th>Trucks</th>
                                <th>Mode</th>
                            </tr>
                        </thead>
                        <tbody id="historyBody">
                            <tr>
                                <td colspan="9" style="text-align: center; padding: 40px;">
                                    <i class="fas fa-database" style="font-size: 3rem; opacity: 0.3; margin-bottom: 15px;"></i>
                                    <br>No history data available
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Summary Stats -->
                <div style="margin-top: 25px; display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 20px;">
                    <div class="stat-card">
                        <h3>Total Records</h3>
                        <div class="value" id="totalRecords">0</div>
                    </div>
                    <div class="stat-card">
                        <h3>Avg Vehicles</h3>
                        <div class="value" id="avgVehicles">0</div>
                    </div>
                    <div class="stat-card">
                        <h3>Peak Vehicles</h3>
                        <div class="value" id="peakVehicles">0</div>
                    </div>
                    <div class="stat-card">
                        <h3>Data Points</h3>
                        <div class="value" id="dataPoints">0</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Analytics Tab -->
        <div id="analyticsTab" class="tab-content">
            <div class="glass-card">
                <h2 style="color: white; margin-bottom: 25px;"><i class="fas fa-chart-pie"></i> Traffic Analytics</h2>
                
                <!-- Charts -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 25px;">
                    <div class="chart-container">
                        <h3 style="margin-bottom: 15px;">Vehicle Distribution</h3>
                        <canvas id="vehicleChart"></canvas>
                    </div>
                    <div class="chart-container">
                        <h3 style="margin-bottom: 15px;">Density Distribution</h3>
                        <canvas id="densityChart"></canvas>
                    </div>
                </div>

                <!-- Analytics Cards -->
                <div class="analytics-grid" id="analyticsGrid"></div>

                <!-- Time Series Chart -->
                <div class="chart-container" style="margin-top: 25px;">
                    <h3 style="margin-bottom: 15px;">Traffic Flow Over Time</h3>
                    <canvas id="timeSeriesChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Predictions Tab -->
        <div id="predictionsTab" class="tab-content">
            <div class="glass-card">
                <h2 style="color: white; margin-bottom: 25px;"><i class="fas fa-brain"></i> AI Predictions</h2>
                
                <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 25px;">
                    <!-- Prediction Chart -->
                    <div class="chart-container">
                        <h3 style="margin-bottom: 15px;">24-Hour Traffic Forecast</h3>
                        <canvas id="predictionChart"></canvas>
                    </div>
                    
                    <!-- Model Info -->
                    <div class="analytics-card">
                        <h3 style="margin-bottom: 20px;">Model Information</h3>
                        <div class="analytics-stat">
                            <span class="label">Model Status:</span>
                            <span class="value" id="modelStatus">Not Trained</span>
                        </div>
                        <div class="analytics-stat">
                            <span class="label">Accuracy:</span>
                            <span class="value" id="modelAccuracy">0%</span>
                        </div>
                        <div class="analytics-stat">
                            <span class="label">Samples Used:</span>
                            <span class="value" id="modelSamples">0</span>
                        </div>
                        <div class="analytics-stat">
                            <span class="label">Last Training:</span>
                            <span class="value" id="lastTraining">Never</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="trainingProgress" style="width: 0%;"></div>
                        </div>
                        <button class="btn btn-primary" onclick="forceTrain()" style="width: 100%; margin-top: 20px;">
                            <i class="fas fa-robot"></i> Train Model Now
                        </button>
                    </div>
                </div>

                <!-- Hourly Predictions -->
                <div class="predictions-panel">
                    <h3 style="color: white; margin-bottom: 20px;">Hourly Density Forecast</h3>
                    <div id="predictionsList"></div>
                </div>
            </div>
        </div>

        <!-- Settings Tab -->
        <div id="settingsTab" class="tab-content">
            <div class="glass-card">
                <h2 style="color: white; margin-bottom: 25px;"><i class="fas fa-sliders-h"></i> System Settings</h2>
                
                <div class="settings-grid">
                    <!-- Storage Settings -->
                    <div class="settings-section">
                        <h3><i class="fas fa-database"></i> Data Storage</h3>
                        <div class="form-group">
                            <label>Storage Interval (seconds):</label>
                            <input type="number" id="storageInterval" value="300" min="60" max="3600" step="60">
                            <div class="help-text">How often to save data to database</div>
                        </div>
                    </div>

                    <!-- Training Settings -->
                    <div class="settings-section">
                        <h3><i class="fas fa-robot"></i> Model Training</h3>
                        <div class="form-group">
                            <label>Auto-training Interval (seconds):</label>
                            <input type="number" id="trainingInterval" value="3600" min="1800" max="86400" step="300">
                        </div>
                        <div class="form-group">
                            <label>Max Training Time (seconds):</label>
                            <input type="number" id="trainingTimeLimit" value="300" min="60" max="1800" step="60">
                        </div>
                        <div class="form-group">
                            <label>Prediction Model:</label>
                            <select id="predictionModel">
                                <option value="random_forest">Random Forest</option>
                                <option value="linear">Linear Regression</option>
                                <option value="xgboost">XGBoost</option>
                            </select>
                        </div>
                    </div>

                    <!-- Signal Durations -->
                    <div class="settings-section">
                        <h3><i class="fas fa-traffic-light"></i> Signal Durations</h3>
                        <div class="signal-durations">
                            <div class="duration-item">
                                <label>RED - LOW</label>
                                <input type="number" id="redLow" value="30" min="5" max="120">
                            </div>
                            <div class="duration-item">
                                <label>RED - MED</label>
                                <input type="number" id="redMedium" value="15" min="5" max="120">
                            </div>
                            <div class="duration-item">
                                <label>RED - HIGH</label>
                                <input type="number" id="redHigh" value="10" min="5" max="120">
                            </div>
                            <div class="duration-item">
                                <label>GREEN - LOW</label>
                                <input type="number" id="greenLow" value="10" min="5" max="120">
                            </div>
                            <div class="duration-item">
                                <label>GREEN - MED</label>
                                <input type="number" id="greenMedium" value="15" min="5" max="120">
                            </div>
                            <div class="duration-item">
                                <label>GREEN - HIGH</label>
                                <input type="number" id="greenHigh" value="30" min="5" max="120">
                            </div>
                            <div class="duration-item">
                                <label>YELLOW</label>
                                <input type="number" id="yellow" value="5" min="3" max="10">
                            </div>
                        </div>
                    </div>

                    <!-- Email Settings -->
                    <div class="settings-section">
                        <h3><i class="fas fa-envelope"></i> Email Alerts</h3>
                        <div class="form-group checkbox">
                            <input type="checkbox" id="alertEnabled" checked>
                            <label>Enable Email Alerts</label>
                        </div>
                        <div class="form-group">
                            <label>Alert Email Address:</label>
                            <input type="email" id="alertEmail" placeholder="admin@example.com">
                        </div>
                    </div>

                    <!-- Alert Types -->
                    <div class="settings-section">
                        <h3><i class="fas fa-bell"></i> Alert Types</h3>
                        <div class="alert-types">
                            <div class="form-group checkbox">
                                <input type="checkbox" id="alertModeAutoManual" checked>
                                <label>AUTO  MANUAL</label>
                            </div>
                            <div class="form-group checkbox">
                                <input type="checkbox" id="alertModeManualAuto" checked>
                                <label>MANUAL  AUTO</label>
                            </div>
                            <div class="form-group checkbox">
                                <input type="checkbox" id="alertCameraInactive" checked>
                                <label>Camera Inactive</label>
                            </div>
                            <div class="form-group checkbox">
                                <input type="checkbox" id="alertTraining" checked>
                                <label>Training Complete</label>
                            </div>
                            <div class="form-group checkbox">
                                <input type="checkbox" id="alertModelUpdate" checked>
                                <label>Model Updates</label>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Camera Inactivity Timeout (seconds):</label>
                            <input type="number" id="cameraTimeout" value="300" min="60" max="3600">
                        </div>
                    </div>

                    <!-- Camera Settings -->
                    <div class="settings-section">
                        <h3><i class="fas fa-camera"></i> Camera Settings</h3>
                        <div class="form-group">
                            <label>Camera Index:</label>
                            <input type="number" id="cameraIndex" value="0" min="0" max="10">
                        </div>
                        <div class="form-group">
                            <label>Frame Skip:</label>
                            <input type="number" id="frameSkip" value="2" min="1" max="10">
                        </div>
                        <div class="form-group">
                            <label>Detection Confidence:</label>
                            <input type="number" id="detectionConfidence" value="0.25" min="0.1" max="0.9" step="0.05">
                        </div>
                    </div>
                </div>

                <!-- Save Button -->
                <div style="display: flex; gap: 20px; justify-content: center; margin-top: 30px;">
                    <button class="btn btn-success" onclick="saveAllSettings()" style="min-width: 200px;">
                        <i class="fas fa-save"></i> Save All Settings
                    </button>
                    <button class="btn btn-info" onclick="testAlert()" style="min-width: 200px;">
                        <i class="fas fa-paper-plane"></i> Test Alert
                    </button>
                </div>
            </div>
        </div>

        <!-- Reports Tab -->
        <div id="reportsTab" class="tab-content">
            <div class="glass-card">
                <h2 style="color: white; margin-bottom: 25px;"><i class="fas fa-file-alt"></i> Traffic Reports</h2>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 25px; margin-bottom: 25px;">
                    <div class="analytics-card">
                        <h3>Generate Report</h3>
                        <div style="margin-top: 20px;">
                            <select id="reportType" class="btn" style="width: 100%; margin-bottom: 15px;">
                                <option value="summary">Summary Report</option>
                                <option value="detailed">Detailed Report</option>
                                <option value="peak">Peak Hours Report</option>
                                <option value="daily">Daily Report</option>
                                <option value="weekly">Weekly Report</option>
                            </select>
                            <button class="btn btn-success" onclick="generateReport()" style="width: 100%;">
                                <i class="fas fa-chart-bar"></i> Generate Report
                            </button>
                        </div>
                    </div>

                    <div class="analytics-card">
                        <h3>Quick Stats</h3>
                        <div class="analytics-stat">
                            <span class="label">Session Duration:</span>
                            <span class="value" id="sessionDuration">0h 0m</span>
                        </div>
                        <div class="analytics-stat">
                            <span class="label">Data Points:</span>
                            <span class="value" id="totalDataPoints">0</span>
                        </div>
                        <div class="analytics-stat">
                            <span class="label">Model Accuracy:</span>
                            <span class="value" id="reportModelAccuracy">0%</span>
                        </div>
                    </div>

                    <div class="analytics-card">
                        <h3>Export Options</h3>
                        <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-top: 20px;">
                            <button class="btn btn-info" onclick="exportJSON()" style="flex: 1;">JSON</button>
                            <button class="btn btn-success" onclick="exportCSV()" style="flex: 1;">CSV</button>
                            <button class="btn btn-danger" onclick="exportPDF()" style="flex: 1;">PDF</button>
                        </div>
                    </div>
                </div>

                <!-- Report Preview -->
                <div id="reportPreview" class="glass-card" style="margin-top: 25px; display: none;">
                    <h3 style="color: white; margin-bottom: 20px;">Report Preview</h3>
                    <div id="reportContent" style="color: white;"></div>
                </div>
            </div>
        </div>

        <!-- Status Bar -->
        <div class="status-bar">
            <div class="status-item">
                <span class="status-dot"></span>
                <span id="currentMode">Standby</span>
                <span class="mode-badge" id="modeBadge">STANDBY</span>
            </div>
            <div class="status-item">
                <i class="fas fa-clock"></i>
                <span id="lastUpdate">-</span>
            </div>
            <div class="status-item">
                <i class="fas fa-microchip"></i>
                <span id="systemStatus">Ready</span>
            </div>
            <div class="status-item">
                <i class="fas fa-database"></i>
                <span id="totalDataPointsStatus">0</span>
            </div>
            <div class="status-item">
                <i class="fas fa-gamepad"></i>
                <span id="modeDisplay">AUTO</span>
            </div>
            <div class="status-item">
                <i class="fas fa-robot"></i>
                <span id="modelStatusDisplay">Not trained</span>
            </div>
            <div class="status-item">
                <i class="fas fa-envelope"></i>
                <span id="alertStatusDisplay">Off</span>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
    </div>

    <!-- Notification -->
    <div class="notification" id="notification"></div>

    <script>
        // ==================== STATE MANAGEMENT ====================
        let statsInterval = null;
        let predictionsInterval = null;
        let currentFileName = '';
        let historyData = [];
        let predictionsData = [];
        let charts = {};
        let currentControlMode = 'AUTO';
        let settings = {
            storageInterval: 300,
            trainingInterval: 3600,
            trainingTimeLimit: 300,
            predictionModel: 'random_forest',
            signalDurations: {
                red: { low: 30, medium: 15, high: 10 },
                green: { low: 10, medium: 15, high: 30 },
                yellow: 5
            },
            alertEnabled: true,
            alertEmail: '',
            alertTypes: {
                modeAutoManual: true,
                modeManualAuto: true,
                cameraInactive: true,
                training: true,
                modelUpdate: true
            },
            cameraTimeout: 300,
            cameraIndex: 0,
            frameSkip: 2,
            detectionConfidence: 0.25
        };

        // DOM Elements
        const videoFeed = document.getElementById('videoFeed');
        const videoPlaceholder = document.getElementById('videoPlaceholder');
        const loadingOverlay = document.getElementById('loadingOverlay');
        const notification = document.getElementById('notification');
        const manualControls = document.getElementById('manualControls');

        // ==================== ANIMATIONS ====================
        function initParticles() {
            const particlesContainer = document.getElementById('particles');
            for (let i = 0; i < 50; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                particle.style.left = Math.random() * 100 + '%';
                particle.style.animationDelay = Math.random() * 20 + 's';
                particle.style.animationDuration = 15 + Math.random() * 20 + 's';
                particlesContainer.appendChild(particle);
            }
        }

        // ==================== INITIALIZATION ====================
        document.addEventListener('DOMContentLoaded', function() {
            initParticles();
            resetDisplay();
            updateStatusBar('Standby', 'Ready');
            updateModeBadge('STANDBY', 'standby');
            setMode('AUTO');
            loadSettingsFromStorage();
            startPeriodicUpdates();
            
            // Animate elements with GSAP
            gsap.from('.header', { duration: 1, y: -50, opacity: 0, ease: 'power3.out' });
            gsap.from('.control-panel', { duration: 1, y: 30, opacity: 0, delay: 0.3, ease: 'power3.out' });
            gsap.from('.tab-container', { duration: 1, y: 30, opacity: 0, delay: 0.6, ease: 'power3.out' });
            gsap.from('.main-grid', { duration: 1, y: 30, opacity: 0, delay: 0.9, ease: 'power3.out' });
            gsap.from('.status-bar', { duration: 1, y: 30, opacity: 0, delay: 1.2, ease: 'power3.out' });
            
            // Fetch initial stats
            fetchStats();
        });

        // ==================== FILE HANDLING ====================
        document.getElementById('mediaFile').addEventListener('change', function(e) {
            if (e.target.files.length > 0) {
                currentFileName = e.target.files[0].name;
                const fileType = e.target.files[0].type.split('/')[0];
                showNotification(`Selected: ${currentFileName} (${fileType})`, 'success');
            }
        });

        // ==================== PERIODIC UPDATES ====================
        function startPeriodicUpdates() {
            if (statsInterval) clearInterval(statsInterval);
            statsInterval = setInterval(fetchStats, 1000);
            
            if (predictionsInterval) clearInterval(predictionsInterval);
            predictionsInterval = setInterval(fetchPredictions, 30000);
            
            if (document.getElementById('historyTab').classList.contains('active')) {
                fetchHistory();
            }
            
            if (document.getElementById('predictionsTab').classList.contains('active')) {
                fetchPredictions();
            }
        }

        // ==================== TAB SWITCHING ====================
        function switchTab(tabName) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');

            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(tabName + 'Tab').classList.add('active');

            // Animate tab content
            gsap.fromTo('#' + tabName + 'Tab', 
                { opacity: 0, y: 30 }, 
                { opacity: 1, y: 0, duration: 0.5, ease: 'power3.out' }
            );

            if (tabName === 'history') {
                fetchHistory();
            } else if (tabName === 'analytics') {
                fetchAnalytics();
            } else if (tabName === 'predictions') {
                fetchPredictions();
            } else if (tabName === 'settings') {
                loadSettingsIntoForm();
            }
        }

        // ==================== API CALLS ====================
        async function fetchStats() {
            try {
                const response = await fetch('/stats');
                if (!response.ok) throw new Error('Failed to fetch stats');
                const data = await response.json();
                updateDisplay(data);
                
                if (data.control_mode) {
                    document.getElementById('modeDisplay').textContent = data.control_mode;
                    manualControls.style.display = data.control_mode === 'MANUAL' ? 'flex' : 'none';
                }
                
                updateAlertStatusDisplay(data.alert_enabled, data.alert_email);
                
            } catch (error) {
                console.error('Stats fetch error:', error);
            }
        }

        async function fetchHistory() {
            showLoading(true);
            try {
                const response = await fetch('/history?limit=100');
                if (!response.ok) throw new Error('Failed to fetch history');
                
                const data = await response.json();
                if (data && data.history) {
                    historyData = data.history;
                    displayHistory(historyData);
                    updateHistoryStats(historyData);
                    
                    if (data.total_records !== undefined) {
                        document.getElementById('totalDataPointsStatus').textContent = data.total_records;
                        document.getElementById('storageInfo').textContent = `Records in DB: ${data.total_records} | Next storage: 5min`;
                    }
                }
                
            } catch (error) {
                console.error('History fetch error:', error);
                showNotification('Failed to fetch history - check backend connection', 'error');
            } finally {
                showLoading(false);
            }
        }

        async function fetchAnalytics() {
            try {
                const response = await fetch('/analytics');
                if (!response.ok) throw new Error('Failed to fetch analytics');
                const data = await response.json();
                displayAnalytics(data.analytics);
                updateCharts(data.analytics);
            } catch (error) {
                console.error('Analytics fetch error:', error);
                showNotification('Failed to fetch analytics - check backend connection', 'error');
            }
        }

        async function fetchPredictions() {
            try {
                const response = await fetch('/predictions');
                if (!response.ok) throw new Error('Failed to fetch predictions');
                const data = await response.json();
                predictionsData = data.predictions || [];
                displayPredictions(data);
                updatePredictionChart(data.predictions);
            } catch (error) {
                console.error('Predictions fetch error:', error);
                const demoData = {
                    predictions: generateDemoPredictions(),
                    model_accuracy: 85.0,
                    samples_used: 100,
                    last_training: new Date().toISOString()
                };
                displayPredictions(demoData);
                updatePredictionChart(demoData.predictions);
            }
        }

        function generateDemoPredictions() {
            const predictions = [];
            const now = new Date();
            
            for (let i = 1; i <= 24; i++) {
                const hour = (now.getHours() + i) % 24;
                let count, density;
                
                if (hour >= 7 && hour <= 9) {
                    count = 18 + (i % 5);
                    density = 'HIGH';
                } else if (hour >= 17 && hour <= 19) {
                    count = 20 + (i % 4);
                    density = 'HIGH';
                } else if (hour >= 10 && hour <= 16) {
                    count = 12 + (i % 4);
                    density = 'MEDIUM';
                } else {
                    count = 5 + (i % 3);
                    density = 'LOW';
                }
                
                predictions.push({
                    hour: i,
                    time: `${hour.toString().padStart(2, '0')}:00`,
                    predicted_count: count,
                    density: density,
                    confidence: 85.0
                });
            }
            
            return predictions;
        }

        // ==================== EMAIL VALIDATION ====================
        function isValidEmail(email) {
            const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return re.test(email);
        }

        // ==================== UPDATED saveAllSettings() ====================
        async function saveAllSettings() {
            // Collect email settings first
            const alertEmail = document.getElementById('alertEmail').value;
            const alertEnabled = document.getElementById('alertEnabled').checked;

            // Validate email if enabled
            if (alertEnabled && alertEmail && !isValidEmail(alertEmail)) {
                showNotification('Please enter a valid email address', 'error');
                return;
            }

            showLoading(true);

            try {
                // Step 1: Save email settings to separate endpoint
                if (alertEmail || alertEnabled) {
                    const emailResponse = await fetch('/save_email', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            alert_email: alertEmail,
                            alert_enabled: alertEnabled
                        })
                    });

                    if (!emailResponse.ok) {
                        const errorData = await emailResponse.json().catch(() => ({}));
                        throw new Error(errorData.message || 'Failed to save email settings');
                    }

                    const emailData = await emailResponse.json();
                    if (!emailData.success) {
                        throw new Error(emailData.message || 'Failed to save email settings');
                    }

                    showNotification('Email settings saved successfully', 'success');
                }

                // Step 2: Collect all other settings
                const otherSettings = {
                    storageInterval: parseInt(document.getElementById('storageInterval').value),
                    trainingInterval: parseInt(document.getElementById('trainingInterval').value),
                    trainingTimeLimit: parseInt(document.getElementById('trainingTimeLimit').value),
                    predictionModel: document.getElementById('predictionModel').value,
                    signalDurations: {
                        red: {
                            low: parseInt(document.getElementById('redLow').value),
                            medium: parseInt(document.getElementById('redMedium').value),
                            high: parseInt(document.getElementById('redHigh').value)
                        },
                        green: {
                            low: parseInt(document.getElementById('greenLow').value),
                            medium: parseInt(document.getElementById('greenMedium').value),
                            high: parseInt(document.getElementById('greenHigh').value)
                        },
                        yellow: parseInt(document.getElementById('yellow').value)
                    },
                    alertTypes: {
                        modeAutoManual: document.getElementById('alertModeAutoManual').checked,
                        modeManualAuto: document.getElementById('alertModeManualAuto').checked,
                        cameraInactive: document.getElementById('alertCameraInactive').checked,
                        training: document.getElementById('alertTraining').checked,
                        modelUpdate: document.getElementById('alertModelUpdate').checked
                    },
                    cameraTimeout: parseInt(document.getElementById('cameraTimeout').value),
                    cameraIndex: parseInt(document.getElementById('cameraIndex').value),
                    frameSkip: parseInt(document.getElementById('frameSkip').value),
                    detectionConfidence: parseFloat(document.getElementById('detectionConfidence').value)
                };

                // Step 3: Save other settings
                const settingsResponse = await fetch('/save_settings', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(otherSettings)
                });

                if (!settingsResponse.ok) {
                    const errorData = await settingsResponse.json().catch(() => ({}));
                    throw new Error(errorData.message || 'Failed to save other settings');
                }

                const settingsData = await settingsResponse.json();
                
                // Save to localStorage
                const fullSettings = { ...otherSettings, alertEmail, alertEnabled };
                localStorage.setItem('trafficSettings', JSON.stringify(fullSettings));
                
                // Update display
                updateSignalTimingsDisplay();
                updateAlertStatusDisplay(alertEnabled, alertEmail);
                
                showNotification('All settings saved successfully', 'success');
                
            } catch (error) {
                showNotification(error.message || 'Failed to save settings', 'error');
                console.error('Save settings error:', error);
            } finally {
                showLoading(false);
            }
        }

        // ==================== UPDATED testAlert() ====================
        async function testAlert() {
            const alertEmail = document.getElementById('alertEmail').value;
            const alertEnabled = document.getElementById('alertEnabled').checked;

            // Validation
            if (!alertEmail) {
                showNotification('Please enter an email address', 'warning');
                return;
            }

            if (!isValidEmail(alertEmail)) {
                showNotification('Please enter a valid email address', 'warning');
                return;
            }

            if (!alertEnabled) {
                showNotification('Alert is disabled. Please enable alerts first.', 'warning');
                return;
            }

            showLoading(true);

            try {
                // Step 1: Save email first
                const emailResponse = await fetch('/save_email', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        alert_email: alertEmail,
                        alert_enabled: alertEnabled
                    })
                });

                if (!emailResponse.ok) {
                    const errorData = await emailResponse.json().catch(() => ({}));
                    throw new Error(errorData.message || 'Failed to save email');
                }

                const emailData = await emailResponse.json();
                if (!emailData.success) {
                    throw new Error(emailData.message || 'Failed to save email');
                }

                // Step 2: Test alert
                const testResponse = await fetch('/test_alert');
                
                if (!testResponse.ok) {
                    const errorData = await testResponse.json().catch(() => ({}));
                    throw new Error(errorData.message || 'Failed to send test alert');
                }

                const testData = await testResponse.json();
                
                // Show exact backend message
                if (testData.success) {
                    showNotification(testData.message || 'Test alert sent successfully', 'success');
                } else {
                    showNotification(testData.message || 'Test alert failed', 'error');
                }
                
            } catch (error) {
                showNotification(error.message, 'error');
                console.error('Test alert error:', error);
            } finally {
                showLoading(false);
            }
        }

        // ==================== UPDATE ALERT STATUS DISPLAY ====================
        function updateAlertStatusDisplay(enabled, email) {
            const alertStatus = document.getElementById('alertStatusDisplay');
            if (enabled && email) {
                alertStatus.textContent = 'On';
                alertStatus.style.color = 'var(--success)';
            } else {
                alertStatus.textContent = 'Off';
                alertStatus.style.color = 'var(--gray)';
            }
        }

        async function setMode(mode) {
            showLoading(true);
            try {
                const response = await fetch(`/set_mode/${mode}`);
                if (!response.ok) throw new Error('Failed to set mode');
                
                const data = await response.json();
                currentControlMode = mode;
                document.getElementById('modeDisplay').textContent = mode;
                
                manualControls.style.display = mode === 'MANUAL' ? 'flex' : 'none';
                
                showNotification(`Switched to ${mode} mode`, 'success');
                
            } catch (error) {
                showNotification('Failed to set mode - check backend connection', 'error');
            } finally {
                showLoading(false);
            }
        }

        async function setSignal(state) {
            showLoading(true);
            try {
                const response = await fetch(`/set_signal/${state}`);
                if (!response.ok) throw new Error('Failed to set signal');
                const data = await response.json();
                showNotification(`Signal set to ${state}`, 'success');
            } catch (error) {
                showNotification('Failed to set signal - check backend connection', 'error');
            } finally {
                showLoading(false);
            }
        }

        async function startCamera() {
            showLoading(true);
            try {
                const response = await fetch('/start_camera');
                if (!response.ok) throw new Error('Failed to start camera');
                const data = await response.json();
                showNotification('Camera started', 'success');
                startVideoFeed();
                updateStatusBar('Camera', 'Live');
                updateModeBadge('CAMERA', 'camera');
            } catch (error) {
                showNotification('Failed to start camera - check backend connection', 'error');
            } finally {
                showLoading(false);
            }
        }

        async function stopCamera() {
            showLoading(true);
            try {
                const response = await fetch('/stop_camera');
                if (!response.ok) throw new Error('Failed to stop camera');
                const data = await response.json();
                showNotification('Camera stopped', 'success');
                stopVideoFeed();
                updateStatusBar('Standby', 'Ready');
                updateModeBadge('STANDBY', 'standby');
            } catch (error) {
                showNotification('Failed to stop camera - check backend connection', 'error');
            } finally {
                showLoading(false);
            }
        }

        async function uploadMedia() {
            const fileInput = document.getElementById('mediaFile');
            if (!fileInput.files.length) {
                showNotification('Please select a media file first', 'error');
                return;
            }

            const formData = new FormData();
            formData.append('video', fileInput.files[0]);

            showLoading(true);
            try {
                const response = await fetch('/upload', {
                    method: 'POST',
                    body: formData
                });
                if (!response.ok) throw new Error('Upload failed');
                const data = await response.json();
                showNotification('Media processing started', 'success');
                startVideoFeed();
                updateStatusBar(data.mode, 'Processing');
                updateModeBadge(data.mode, data.mode.toLowerCase());
            } catch (error) {
                showNotification('Upload failed - check backend connection', 'error');
            } finally {
                showLoading(false);
            }
        }

        async function forceStore() {
            showLoading(true);
            try {
                const response = await fetch('/force_store');
                if (!response.ok) throw new Error('Failed to store data');
                const data = await response.json();
                showNotification(`Data stored! Total records: ${data.total_records}`, 'success');
                if (document.getElementById('historyTab').classList.contains('active')) {
                    fetchHistory();
                }
            } catch (error) {
                showNotification('Failed to store data - check backend connection', 'error');
            } finally {
                showLoading(false);
            }
        }

        async function forceTrain() {
            showLoading(true);
            try {
                const response = await fetch('/force_train');
                if (!response.ok) throw new Error('Failed to start training');
                const data = await response.json();
                showNotification('Model training started', 'success');
                
                setTimeout(() => {
                    fetchPredictions();
                }, 5000);
                
            } catch (error) {
                showNotification('Failed to start training - check backend connection', 'error');
            } finally {
                showLoading(false);
            }
        }

        async function checkDatabase() {
            showLoading(true);
            try {
                const response = await fetch('/db_stats');
                if (!response.ok) throw new Error('Failed to get DB stats');
                const data = await response.json();
                
                let message = ` Database Stats:\n`;
                message += `Traffic History: ${data.traffic_history} records\n`;
                message += `Sessions: ${data.sessions}\n`;
                message += `Predictions: ${data.predictions || 0}\n`;
                message += `Database Size: ${data.database_size_kb || 0} KB\n`;
                message += `Alert Email: ${data.alert_email || 'Not set'}\n`;
                message += `Alert Enabled: ${data.alert_enabled ? 'Yes' : 'No'}\n`;
                if (data.latest_record) {
                    message += `Latest: ${data.latest_record.timestamp} (${data.latest_record.vehicles} vehicles)`;
                }
                
                alert(message);
                
            } catch (error) {
                showNotification('Failed to get DB stats - check backend connection', 'error');
            } finally {
                showLoading(false);
            }
        }

        // ==================== EXPORT FUNCTIONS ====================
        async function exportJSON() {
            if (!historyData || historyData.length === 0) {
                showNotification('No data to export', 'warning');
                return;
            }
            
            window.location.href = '/export/json';
            showNotification('Exporting JSON...', 'info');
        }

        async function exportCSV() {
            if (!historyData || historyData.length === 0) {
                showNotification('No data to export', 'warning');
                return;
            }
            
            window.location.href = '/export/csv';
            showNotification('Exporting CSV...', 'info');
        }

        async function exportPDF() {
            if (!historyData || historyData.length === 0) {
                showNotification('No data to export', 'warning');
                return;
            }
            
            window.location.href = '/export/pdf';
            showNotification('Exporting PDF...', 'info');
        }

        // ==================== VIDEO FEED ====================
        function startVideoFeed() {
            videoFeed.src = '/video_feed';
            videoFeed.style.display = 'block';
            videoPlaceholder.style.display = 'none';
        }

        function stopVideoFeed() {
            videoFeed.src = '';
            videoFeed.style.display = 'none';
            videoPlaceholder.style.display = 'flex';
        }

        // ==================== DISPLAY UPDATES ====================
        function updateDisplay(data) {
            document.getElementById('totalVehicles').textContent = data.total_vehicles || 0;
            document.getElementById('densityLevel').textContent = data.density_level || 'LOW';
            document.getElementById('signalState').textContent = data.signal_state || 'RED';
            document.getElementById('remainingTimer').textContent = (data.signal_timer || 0) + 's';
            document.getElementById('timerDisplay').textContent = (data.signal_timer || 0) + 's';

            const counts = data.vehicle_counts || {};
            document.getElementById('carCount').textContent = counts.car || 0;
            document.getElementById('motorcycleCount').textContent = counts.motorcycle || 0;
            document.getElementById('busCount').textContent = counts.bus || 0;
            document.getElementById('truckCount').textContent = counts.truck || 0;

            updateTrafficLights(data.signal_state);

            document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();
            document.getElementById('systemStatus').textContent = data.processing_active ? 'Active' : 'Ready';
            document.getElementById('currentMode').textContent = data.current_mode || 'Standby';
            
            if (data.model_accuracy) {
                document.getElementById('modelStatusDisplay').textContent = `Trained (${data.model_accuracy}%)`;
                if (document.getElementById('modelAccuracy')) {
                    document.getElementById('modelAccuracy').textContent = data.model_accuracy + '%';
                }
            }
            
            updateAlertStatusDisplay(data.alert_enabled, data.alert_email);
        }

        function updateTrafficLights(state) {
            document.getElementById('redLight').classList.remove('active');
            document.getElementById('yellowLight').classList.remove('active');
            document.getElementById('greenLight').classList.remove('active');

            switch(state) {
                case 'RED':
                    document.getElementById('redLight').classList.add('active');
                    break;
                case 'YELLOW':
                    document.getElementById('yellowLight').classList.add('active');
                    break;
                case 'GREEN':
                    document.getElementById('greenLight').classList.add('active');
                    break;
            }
        }

        function updateSignalTimingsDisplay() {
            const lowRed = document.getElementById('redLow').value;
            const lowGreen = document.getElementById('greenLow').value;
            const medRed = document.getElementById('redMedium').value;
            const medGreen = document.getElementById('greenMedium').value;
            const highRed = document.getElementById('redHigh').value;
            const highGreen = document.getElementById('greenHigh').value;
            const yellow = document.getElementById('yellow').value;
            
            document.getElementById('lowTimings').textContent = 
                `G:${lowGreen} Y:${yellow} R:${lowRed}`;
            document.getElementById('mediumTimings').textContent = 
                `G:${medGreen} Y:${yellow} R:${medRed}`;
            document.getElementById('highTimings').textContent = 
                `G:${highGreen} Y:${yellow} R:${highRed}`;
        }

        function updateStatusBar(mode, status) {
            document.getElementById('currentMode').textContent = mode;
            document.getElementById('systemStatus').textContent = status;
        }

        function updateModeBadge(mode, type) {
            const badge = document.getElementById('modeBadge');
            badge.textContent = mode;
            badge.className = 'mode-badge';
        }

        function resetDisplay() {
            document.getElementById('totalVehicles').textContent = '0';
            document.getElementById('densityLevel').textContent = 'LOW';
            document.getElementById('signalState').textContent = 'RED';
            document.getElementById('remainingTimer').textContent = '0s';
            document.getElementById('timerDisplay').textContent = '0s';
            document.getElementById('carCount').textContent = '0';
            document.getElementById('motorcycleCount').textContent = '0';
            document.getElementById('busCount').textContent = '0';
            document.getElementById('truckCount').textContent = '0';
            
            updateTrafficLights('RED');
        }

        // ==================== HISTORY ====================
        function displayHistory(data) {
            const tbody = document.getElementById('historyBody');
            
            if (!data || data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" style="text-align: center; padding: 40px;"><i class="fas fa-database" style="font-size: 3rem; opacity: 0.3; margin-bottom: 15px;"></i><br>No history data available</td></tr>';
                return;
            }

            let html = '';
            data.slice(0, 50).forEach(item => {
                const vehicleDetails = item.vehicle_details || {};
                html += `
                    <tr>
                        <td>${new Date(item.timestamp).toLocaleString()}</td>
                        <td>${item.vehicle_count || 0}</td>
                        <td><span class="density-badge ${(item.density || 'LOW').toLowerCase()}">${item.density || 'LOW'}</span></td>
                        <td><span class="signal-badge ${(item.signal_state || 'RED').toLowerCase()}">${item.signal_state || 'RED'}</span></td>
                        <td>${vehicleDetails.car || 0}</td>
                        <td>${vehicleDetails.motorcycle || 0}</td>
                        <td>${vehicleDetails.bus || 0}</td>
                        <td>${vehicleDetails.truck || 0}</td>
                        <td>${item.mode || 'STANDBY'}</td>
                    </tr>
                `;
            });

            tbody.innerHTML = html;
        }

        function updateHistoryStats(data) {
            if (!data || data.length === 0) return;

            const totalRecords = data.length;
            const vehicleCounts = data.map(item => item.vehicle_count || 0);
            const avgVehicles = Math.round(vehicleCounts.reduce((a, b) => a + b, 0) / totalRecords);
            const peakVehicles = Math.max(...vehicleCounts);

            document.getElementById('totalRecords').textContent = totalRecords;
            document.getElementById('avgVehicles').textContent = avgVehicles;
            document.getElementById('peakVehicles').textContent = peakVehicles;
            document.getElementById('dataPoints').textContent = totalRecords;
        }

        // ==================== ANALYTICS ====================
        function displayAnalytics(analytics) {
            if (!analytics) return;

            const grid = document.getElementById('analyticsGrid');
            
            let html = `
                <div class="analytics-card">
                    <h3>Summary Statistics</h3>
                    <div class="analytics-stat">
                        <span class="label">Average Vehicles:</span>
                        <span class="value">${analytics.average_vehicles?.toFixed(1) || 0}</span>
                    </div>
                    <div class="analytics-stat">
                        <span class="label">Max Vehicles:</span>
                        <span class="value">${analytics.max_vehicles || 0}</span>
                    </div>
                    <div class="analytics-stat">
                        <span class="label">Min Vehicles:</span>
                        <span class="value">${analytics.min_vehicles || 0}</span>
                    </div>
                    <div class="analytics-stat">
                        <span class="label">Total Data Points:</span>
                        <span class="value">${analytics.total_data_points || 0}</span>
                    </div>
                </div>
            `;

            if (analytics.vehicle_type_distribution) {
                html += '<div class="analytics-card"><h3>Vehicle Distribution</h3>';
                for (const [type, count] of Object.entries(analytics.vehicle_type_distribution)) {
                    html += `
                        <div class="analytics-stat">
                            <span class="label">${type}:</span>
                            <span class="value">${count}</span>
                        </div>
                    `;
                }
                html += '</div>';
            }

            if (analytics.density_distribution) {
                html += '<div class="analytics-card"><h3>Density Distribution</h3>';
                for (const [density, count] of Object.entries(analytics.density_distribution)) {
                    html += `
                        <div class="analytics-stat">
                            <span class="label">${density}:</span>
                            <span class="value">${count}</span>
                        </div>
                    `;
                }
                html += '</div>';
            }

            grid.innerHTML = html;

            if (analytics.start_time && analytics.end_time) {
                const start = new Date(analytics.start_time);
                const end = new Date(analytics.end_time);
                const durationMs = end - start;
                const hours = Math.floor(durationMs / 3600000);
                const minutes = Math.floor((durationMs % 3600000) / 60000);
                document.getElementById('sessionDuration').textContent = `${hours}h ${minutes}m`;
            }

            document.getElementById('totalDataPoints').textContent = analytics.total_data_points || 0;
        }

        // ==================== CHARTS ====================
        function updateCharts(analytics) {
            if (!analytics) return;

            Object.values(charts).forEach(chart => {
                if (chart) chart.destroy();
            });

            // Vehicle Distribution Chart
            const vehicleCtx = document.getElementById('vehicleChart').getContext('2d');
            if (analytics.vehicle_type_distribution && Object.keys(analytics.vehicle_type_distribution).length > 0) {
                charts.vehicleChart = new Chart(vehicleCtx, {
                    type: 'pie',
                    data: {
                        labels: Object.keys(analytics.vehicle_type_distribution),
                        datasets: [{
                            data: Object.values(analytics.vehicle_type_distribution),
                            backgroundColor: ['#4cc9f0', '#f8961e', '#f94144', '#4361ee']
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                labels: { color: 'white' }
                            }
                        }
                    }
                });
            }

            // Density Distribution Chart
            const densityCtx = document.getElementById('densityChart').getContext('2d');
            if (analytics.density_distribution && Object.keys(analytics.density_distribution).length > 0) {
                charts.densityChart = new Chart(densityCtx, {
                    type: 'doughnut',
                    data: {
                        labels: Object.keys(analytics.density_distribution),
                        datasets: [{
                            data: Object.values(analytics.density_distribution),
                            backgroundColor: ['#4cc9f0', '#f8961e', '#f94144']
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                labels: { color: 'white' }
                            }
                        }
                    }
                });
            }

            // Time Series Chart
            if (historyData.length > 0) {
                const timeCtx = document.getElementById('timeSeriesChart').getContext('2d');
                const recentHistory = historyData.slice(0, 50).reverse();
                const times = recentHistory.map(item => new Date(item.timestamp).toLocaleTimeString());
                const vehicles = recentHistory.map(item => item.vehicle_count || 0);

                if (charts.timeSeriesChart) {
                    charts.timeSeriesChart.destroy();
                }

                charts.timeSeriesChart = new Chart(timeCtx, {
                    type: 'line',
                    data: {
                        labels: times,
                        datasets: [{
                            label: 'Vehicle Count',
                            data: vehicles,
                            borderColor: '#4361ee',
                            backgroundColor: 'rgba(67, 97, 238, 0.1)',
                            tension: 0.4,
                            fill: true,
                            pointBackgroundColor: '#4361ee',
                            pointBorderColor: 'white',
                            pointBorderWidth: 2,
                            pointRadius: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                grid: { color: 'rgba(255, 255, 255, 0.1)' },
                                ticks: { color: 'white' }
                            },
                            x: {
                                grid: { display: false },
                                ticks: { color: 'white', maxRotation: 45 }
                            }
                        },
                        plugins: {
                            legend: {
                                labels: { color: 'white' }
                            }
                        }
                    }
                });
            }
        }

        // ==================== PREDICTIONS ====================
        function displayPredictions(data) {
            const predictions = data.predictions || [];
            const modelAccuracy = data.model_accuracy || 0;
            const samplesUsed = data.samples_used || 0;
            const lastTraining = data.last_training ? new Date(data.last_training).toLocaleString() : 'Never';
            
            document.getElementById('modelStatus').textContent = predictions.length > 0 ? 'Trained' : 'Not Trained';
            document.getElementById('modelAccuracy').textContent = modelAccuracy.toFixed(1) + '%';
            document.getElementById('modelSamples').textContent = samplesUsed;
            document.getElementById('lastTraining').textContent = lastTraining;
            document.getElementById('reportModelAccuracy').textContent = modelAccuracy.toFixed(1) + '%';
            document.getElementById('modelStatusDisplay').textContent = predictions.length > 0 ? `Trained (${modelAccuracy.toFixed(1)}%)` : 'Not trained';
            
            document.getElementById('trainingProgress').style.width = predictions.length > 0 ? '100%' : '0%';
            
            let listHtml = '';
            if (predictions && predictions.length > 0) {
                listHtml = predictions.map(p => {
                    const densityClass = (p.density || 'LOW').toLowerCase();
                    const count = p.predicted_count || '';
                    const confidence = p.confidence ? p.confidence.toFixed(0) : '';
                    return `
                        <div class="prediction-item">
                            <span class="prediction-hour">${p.time || p.hour + ':00'}</span>
                            <span class="prediction-density ${densityClass}">${p.density || 'LOW'}</span>
                            <span>${count} vehicles</span>
                            <span style="font-size: 0.8rem; opacity: 0.7;">${confidence}%</span>
                        </div>
                    `;
                }).join('');
            } else {
                listHtml = '<div style="text-align: center; padding: 40px;"><i class="fas fa-chart-line" style="font-size: 3rem; opacity: 0.3; margin-bottom: 15px;"></i><br>No predictions available. Click "Train Model" to generate predictions.</div>';
            }
            
            document.getElementById('predictionsList').innerHTML = listHtml;
            
            updatePredictionChart(predictions);
        }

        function updatePredictionChart(predictions) {
            if (!predictions || predictions.length === 0) {
                const ctx = document.getElementById('predictionChart').getContext('2d');
                if (charts.predictionChart) {
                    charts.predictionChart.destroy();
                }
                
                const hours = Array.from({length: 24}, (_, i) => `${i+1}:00`);
                const emptyData = Array(24).fill(0);
                
                charts.predictionChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: hours,
                        datasets: [{
                            label: 'No predictions yet',
                            data: emptyData,
                            borderColor: '#4361ee',
                            backgroundColor: 'rgba(67, 97, 238, 0.1)',
                            borderDash: [5, 5]
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                grid: { color: 'rgba(255, 255, 255, 0.1)' },
                                ticks: { color: 'white' }
                            },
                            x: {
                                grid: { display: false },
                                ticks: { color: 'white', maxRotation: 45 }
                            }
                        },
                        plugins: {
                            legend: {
                                labels: { color: 'white' }
                            }
                        }
                    }
                });
                return;
            }
            
            const ctx = document.getElementById('predictionChart').getContext('2d');
            
            if (charts.predictionChart) {
                charts.predictionChart.destroy();
            }
            
            const hours = predictions.map(p => p.time || `${p.hour}:00`);
            const values = predictions.map(p => p.predicted_count || 0);
            
            charts.predictionChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: hours,
                    datasets: [{
                        label: 'Predicted Vehicles',
                        data: values,
                        borderColor: '#4361ee',
                        backgroundColor: 'rgba(67, 97, 238, 0.1)',
                        tension: 0.4,
                        fill: true,
                        pointBackgroundColor: values.map(v => 
                            v <= 7 ? '#4cc9f0' : v <= 15 ? '#f8961e' : '#f94144'
                        ),
                        pointBorderColor: 'white',
                        pointBorderWidth: 2,
                        pointRadius: 5
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { color: 'rgba(255, 255, 255, 0.1)' },
                            ticks: { color: 'white' }
                        },
                        x: {
                            grid: { display: false },
                            ticks: { color: 'white', maxRotation: 45 }
                        }
                    },
                    plugins: {
                        legend: {
                            labels: { color: 'white' }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    label += context.raw + ' vehicles';
                                    return label;
                                }
                            }
                        }
                    }
                }
            });
        }

        // ==================== REPORTS ====================
        function generateReport() {
            const reportType = document.getElementById('reportType').value;
            showLoading(true);

            try {
                let reportContent = '';
                
                switch(reportType) {
                    case 'summary':
                        reportContent = generateSummaryReport();
                        break;
                    case 'detailed':
                        reportContent = generateDetailedReport();
                        break;
                    case 'peak':
                        reportContent = generatePeakHoursReport();
                        break;
                    case 'daily':
                        reportContent = generateDailyReport();
                        break;
                    case 'weekly':
                        reportContent = generateWeeklyReport();
                        break;
                }

                document.getElementById('reportContent').innerHTML = reportContent;
                document.getElementById('reportPreview').style.display = 'block';
                showNotification('Report generated successfully', 'success');
                
            } catch (error) {
                showNotification('Failed to generate report', 'error');
                console.error(error);
            } finally {
                showLoading(false);
            }
        }

        function generateSummaryReport() {
            if (!historyData || historyData.length === 0) {
                return '<p>No data available for report</p>';
            }

            const totalVehicles = historyData.reduce((sum, item) => sum + (item.vehicle_count || 0), 0);
            const avgVehicles = Math.round(totalVehicles / historyData.length);
            const maxVehicles = Math.max(...historyData.map(item => item.vehicle_count || 0));

            return `
                <h4>Summary Report - ${new Date().toLocaleDateString()}</h4>
                <div class="analytics-stat"><span class="label">Report Period:</span> <span class="value">Last ${historyData.length} records</span></div>
                <div class="analytics-stat"><span class="label">Total Data Points:</span> <span class="value">${historyData.length}</span></div>
                <div class="analytics-stat"><span class="label">Total Vehicles:</span> <span class="value">${totalVehicles}</span></div>
                <div class="analytics-stat"><span class="label">Average Vehicles:</span> <span class="value">${avgVehicles}</span></div>
                <div class="analytics-stat"><span class="label">Peak Vehicles:</span> <span class="value">${maxVehicles}</span></div>
            `;
        }

        function generateDetailedReport() {
            if (!historyData || historyData.length === 0) {
                return '<p>No data available for report</p>';
            }

            const recentData = historyData.slice(0, 20);

            let html = `
                <h4>Detailed Report - ${new Date().toLocaleDateString()}</h4>
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr>
                            <th style="text-align: left; padding: 8px; border-bottom: 1px solid rgba(255,255,255,0.2);">Time</th>
                            <th style="text-align: left; padding: 8px; border-bottom: 1px solid rgba(255,255,255,0.2);">Vehicles</th>
                            <th style="text-align: left; padding: 8px; border-bottom: 1px solid rgba(255,255,255,0.2);">Density</th>
                            <th style="text-align: left; padding: 8px; border-bottom: 1px solid rgba(255,255,255,0.2);">Signal</th>
                            <th style="text-align: left; padding: 8px; border-bottom: 1px solid rgba(255,255,255,0.2);">Cars</th>
                            <th style="text-align: left; padding: 8px; border-bottom: 1px solid rgba(255,255,255,0.2);">Mcycles</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            recentData.forEach(item => {
                html += `
                    <tr>
                        <td style="padding: 8px; border-bottom: 1px solid rgba(255,255,255,0.1);">${new Date(item.timestamp).toLocaleString()}</td>
                        <td style="padding: 8px; border-bottom: 1px solid rgba(255,255,255,0.1);">${item.vehicle_count || 0}</td>
                        <td style="padding: 8px; border-bottom: 1px solid rgba(255,255,255,0.1);">${item.density || 'LOW'}</td>
                        <td style="padding: 8px; border-bottom: 1px solid rgba(255,255,255,0.1);">${item.signal_state || 'RED'}</td>
                        <td style="padding: 8px; border-bottom: 1px solid rgba(255,255,255,0.1);">${item.vehicle_details?.car || 0}</td>
                        <td style="padding: 8px; border-bottom: 1px solid rgba(255,255,255,0.1);">${item.vehicle_details?.motorcycle || 0}</td>
                    </tr>
                `;
            });

            html += '</tbody></table>';
            return html;
        }

        function generatePeakHoursReport() {
            if (!historyData || historyData.length === 0) {
                return '<p>No data available for report</p>';
            }

            const hourlyData = {};
            historyData.forEach(item => {
                const hour = new Date(item.timestamp).getHours();
                if (!hourlyData[hour]) {
                    hourlyData[hour] = { total: 0, count: 0, max: 0 };
                }
                hourlyData[hour].total += item.vehicle_count || 0;
                hourlyData[hour].count += 1;
                hourlyData[hour].max = Math.max(hourlyData[hour].max, item.vehicle_count || 0);
            });

            for (const [hour, d] of Object.entries(hourlyData)) {
                d.avg = Math.round(d.total / d.count);
            }

            const sortedHours = Object.entries(hourlyData)
                .sort((a, b) => b[1].avg - a[1].avg);

            let html = `
                <h4>Peak Hours Report</h4>
                <div class="analytics-stat"><span class="label">Peak Hour:</span> <span class="value">${sortedHours[0][0]}:00 (${sortedHours[0][1].avg} avg vehicles)</span></div>
                <table style="width: 100%; margin-top: 15px;">
                    <thead>
                        <tr>
                            <th style="text-align: left; padding: 8px;">Hour</th>
                            <th style="text-align: left; padding: 8px;">Avg Vehicles</th>
                            <th style="text-align: left; padding: 8px;">Max Vehicles</th>
                            <th style="text-align: left; padding: 8px;">Samples</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            for (const [hour, d] of sortedHours.slice(0, 10)) {
                html += `
                    <tr>
                        <td style="padding: 8px;">${hour}:00</td>
                        <td style="padding: 8px;">${d.avg}</td>
                        <td style="padding: 8px;">${d.max}</td>
                        <td style="padding: 8px;">${d.count}</td>
                    </tr>
                `;
            }

            html += '</tbody></table>';
            return html;
        }

        function generateDailyReport() {
            if (!historyData || historyData.length === 0) {
                return '<p>No data available for report</p>';
            }

            const today = new Date().toDateString();
            const todayData = historyData.filter(item => 
                new Date(item.timestamp).toDateString() === today
            );

            if (todayData.length === 0) {
                return '<p>No data available for today</p>';
            }

            const totalVehicles = todayData.reduce((sum, item) => sum + (item.vehicle_count || 0), 0);
            const avgVehicles = Math.round(totalVehicles / todayData.length);
            const peakVehicles = Math.max(...todayData.map(item => item.vehicle_count || 0));

            return `
                <h4>Daily Report - ${today}</h4>
                <div class="analytics-stat"><span class="label">Data Points Today:</span> <span class="value">${todayData.length}</span></div>
                <div class="analytics-stat"><span class="label">Total Vehicles Today:</span> <span class="value">${totalVehicles}</span></div>
                <div class="analytics-stat"><span class="label">Average Vehicles:</span> <span class="value">${avgVehicles}</span></div>
                <div class="analytics-stat"><span class="label">Peak Vehicles:</span> <span class="value">${peakVehicles}</span></div>
            `;
        }

        function generateWeeklyReport() {
            if (!historyData || historyData.length === 0) {
                return '<p>No data available for report</p>';
            }

            const oneWeekAgo = new Date();
            oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);
            
            const weekData = historyData.filter(item => 
                new Date(item.timestamp) >= oneWeekAgo
            );

            if (weekData.length === 0) {
                return '<p>No data available for last 7 days</p>';
            }

            const totalVehicles = weekData.reduce((sum, item) => sum + (item.vehicle_count || 0), 0);
            const avgDaily = Math.round(totalVehicles / 7);

            return `
                <h4>Weekly Report - Last 7 Days</h4>
                <div class="analytics-stat"><span class="label">Data Points (7 days):</span> <span class="value">${weekData.length}</span></div>
                <div class="analytics-stat"><span class="label">Total Vehicles (7 days):</span> <span class="value">${totalVehicles}</span></div>
                <div class="analytics-stat"><span class="label">Average Daily:</span> <span class="value">${avgDaily} vehicles</span></div>
            `;
        }

        // ==================== HISTORY FUNCTIONS ====================
        function refreshHistory() {
            showLoading(true);
            fetchHistory();
            showLoading(false);
            showNotification('History refreshed', 'success');
        }

        // ==================== SETTINGS ====================
        function loadSettingsFromStorage() {
            const saved = localStorage.getItem('trafficSettings');
            if (saved) {
                try {
                    settings = JSON.parse(saved);
                } catch (e) {
                    console.error('Failed to parse saved settings');
                }
            }
            loadSettingsIntoForm();
        }

        function loadSettingsIntoForm() {
            document.getElementById('storageInterval').value = settings.storageInterval;
            document.getElementById('trainingInterval').value = settings.trainingInterval;
            document.getElementById('trainingTimeLimit').value = settings.trainingTimeLimit;
            document.getElementById('predictionModel').value = settings.predictionModel;
            
            document.getElementById('redLow').value = settings.signalDurations.red.low;
            document.getElementById('redMedium').value = settings.signalDurations.red.medium;
            document.getElementById('redHigh').value = settings.signalDurations.red.high;
            document.getElementById('greenLow').value = settings.signalDurations.green.low;
            document.getElementById('greenMedium').value = settings.signalDurations.green.medium;
            document.getElementById('greenHigh').value = settings.signalDurations.green.high;
            document.getElementById('yellow').value = settings.signalDurations.yellow;
            
            document.getElementById('alertEnabled').checked = settings.alertEnabled;
            document.getElementById('alertEmail').value = settings.alertEmail;
            
            document.getElementById('alertModeAutoManual').checked = settings.alertTypes.modeAutoManual;
            document.getElementById('alertModeManualAuto').checked = settings.alertTypes.modeManualAuto;
            document.getElementById('alertCameraInactive').checked = settings.alertTypes.cameraInactive;
            document.getElementById('alertTraining').checked = settings.alertTypes.training;
            document.getElementById('alertModelUpdate').checked = settings.alertTypes.modelUpdate;
            
            document.getElementById('cameraTimeout').value = settings.cameraTimeout;
            document.getElementById('cameraIndex').value = settings.cameraIndex;
            document.getElementById('frameSkip').value = settings.frameSkip;
            document.getElementById('detectionConfidence').value = settings.detectionConfidence;
            
            updateSignalTimingsDisplay();
            updateAlertStatusDisplay(settings.alertEnabled, settings.alertEmail);
        }

        // ==================== UTILITIES ====================
        function showLoading(show) {
            loadingOverlay.style.display = show ? 'flex' : 'none';
        }

        function showNotification(message, type) {
            notification.textContent = message;
            notification.className = `notification ${type}`;
            notification.style.display = 'block';

            setTimeout(() => {
                notification.style.display = 'none';
            }, 3000);
        }

        // Cleanup
        window.addEventListener('beforeunload', function() {
            if (statsInterval) clearInterval(statsInterval);
            if (predictionsInterval) clearInterval(predictionsInterval);
        });
    </script>
</body>
</html>
